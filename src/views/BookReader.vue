<template>
    <header class=" sticky top-0 z-[3000] w-full bg-white/90  backdrop-blur-md text-sm py-5   dark:bg-black/80">
    <nav class="flex items-center justify-between px-5" aria-label="Global">
      <div class="flex items-center gap-4">

        <button @click="goHome" class="bg-[url('assets/img/grid.svg')] dark:bg-[url('assets/img/grid-white.svg')] bg-no-repeat text-transparent w-[20px] h-[20px]">Home</button>
        <div id="book-title" class="font-bold text-lg"></div>
        
      </div>
      <div class="flex items-center gap-2">
        <button class="toc bg-[url('assets/img/list.svg')] dark:bg-[url('assets/img/list-white.svg')] bg-no-repeat text-transparent w-[20px] h-[20px]" data-hs-overlay="#hs-overlay-right"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25A2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
</svg>
</button> 
        <button @click="openSidebarWithSummary" class="ml-2 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center" title="AI Summary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423L16.5 15.75l.394 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
          </svg>
        </button>
        <button @click="generateQuiz" class="ml-2 p-2 rounded-full bg-blue-200 dark:bg-blue-700 text-blue-700 dark:text-blue-200 hover:bg-blue-300 dark:hover:bg-blue-600 flex items-center justify-center" title="Â∞èÊµãËØï" :disabled="isGeneratingQuiz">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
          </svg>
        </button>
        <button @click="openChatSidebar" class="ml-2 p-2 rounded-full bg-green-200 dark:bg-green-700 text-green-700 dark:text-green-200 hover:bg-green-300 dark:hover:bg-green-600 flex items-center justify-center" title="AIËÅäÂ§©">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
          </svg>
        </button>
      </div>
    </nav>

  </header>

 

    <div class="book-content" :class="{ 'with-sidebar': showSidebar, 'with-chat-sidebar': showChatSidebar }">
      <div id="viewer" class="scrolled max-w-4xl ml-auto mr-auto mb-20"  :class="{ 'hidden': isResizing }"></div>
      <div @click="goPrev" class="text-transparent fixed top-0 left-0 h-screen w-12 lg:w-20 bg-transparent flex flex-col hover:cursor-pointer bg-[url('assets/img/back.svg')] dark:bg-[url('assets/img/back-white.svg')] bg-no-repeat bg-[center_left_10px]">
        Prev
      </div>
      <div @click="goNext" class="text-transparent fixed top-0 right-0 h-screen w-12 lg:w-20 bg-transparent flex flex-col hover:cursor-pointer bg-[url('assets/img/forward.svg')] dark:bg-[url('assets/img/forward-white.svg')] bg-no-repeat bg-[center_right_10px]">
        Next
      </div>
      <!-- ‰∏ä‰∏ãÊñáËèúÂçï -->
      <div 
        v-show="showContextMenu" 
        :style="{ left: contextMenuPosition.x + 'px', top: contextMenuPosition.y + 'px' }"
        class="context-menu fixed z-[5000] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-2"
        @mouseenter="contextMenuHovering = true" @mouseleave="handleContextMenuLeave"
      >
        <!-- Ë∞ÉËØï‰ø°ÊÅØ -->
        <div class="text-xs text-gray-500 mb-1">showContextMenu: {{ showContextMenu }}</div>
        
        <!-- Êñ∞Âª∫È´ò‰∫ÆÊåâÈíÆ -->
        <button 
          v-if="!isHoveringHighlight"
          @click="highlightSelection"
          class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded w-full"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243-1.59-1.59" />
          </svg>
          È´ò‰∫Æ
        </button>
        
        <!-- Ê∑ªÂä†Á¨îËÆ∞ÊåâÈíÆ -->
        <button 
          v-if="!isHoveringHighlight"
          @click="showNoteInputDialog"
          class="flex items-center gap-2 px-3 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded w-full"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
          </svg>
          Ê∑ªÂä†Á¨îËÆ∞
        </button>
        
        <!-- Á¨îËÆ∞ÊòæÁ§∫Âå∫Âüü -->
        <div 
          v-if="isHoveringHighlight && getHighlightNote(hoveredHighlightId)"
          class="px-3 py-2 border-t border-gray-200 dark:border-gray-600 mt-1"
          @mouseenter="contextMenuHovering = true" @mouseleave="handleContextMenuLeave"
        >
          <div class="text-xs text-gray-500 mb-1 font-medium">üìù Á¨îËÆ∞</div>
          <div class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 p-2 rounded border-l-2 border-blue-500">
            {{ getHighlightNote(hoveredHighlightId) }}
          </div>
        </div>
        
        <!-- RelinkÊåâÈíÆ -->
        <button 
          v-if="isHoveringHighlight && hoveredHighlightId"
          @click="showRelinkForHighlight"
          class="flex items-center gap-2 px-3 py-2 text-sm text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded w-full mt-1"
          @mouseenter="contextMenuHovering = true" @mouseleave="handleContextMenuLeave"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          Relink
        </button>
        
        <!-- Âà†Èô§È´ò‰∫ÆÊåâÈíÆ -->
        <button 
          v-if="isHoveringHighlight && hoveredHighlightId"
          @click="removeHighlight(hoveredHighlightId)"
          class="flex items-center gap-2 px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded w-full mt-1"
          @mouseenter="contextMenuHovering = true" @mouseleave="handleContextMenuLeave"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Âà†Èô§È´ò‰∫Æ
        </button>
      </div>
      
      <!-- Á¨îËÆ∞ËæìÂÖ•Ê°Ü -->
      <div 
        v-if="showNoteInput"
        :style="{ left: noteInputPosition.x + 'px', top: noteInputPosition.y + 'px' }"
        class="note-input fixed z-[5001] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4 min-w-[300px] max-w-[400px]"
        @mouseenter="noteInputHovering = true" @mouseleave="handleNoteInputLeave"
      >
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-200">Ê∑ªÂä†Á¨îËÆ∞</h3>
          <button 
            @click="hideNoteInput"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <div class="mb-3">
          <div class="text-xs text-gray-500 mb-2">ÈÄâ‰∏≠ÊñáÊú¨Ôºö</div>
          <div class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 p-2 rounded border">
            {{ selectedText }}
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-xs text-gray-500 mb-2">Á¨îËÆ∞ÂÜÖÂÆπÔºö</label>
          <textarea 
            v-model="currentNoteText"
            @keydown.ctrl.enter="saveNote"
            placeholder="ËæìÂÖ•‰Ω†ÁöÑÁ¨îËÆ∞..."
            class="w-full h-24 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
          ></textarea>
        </div>
        
        <div class="flex justify-end gap-2">
          <button 
            @click="hideNoteInput"
            class="px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
          >
            ÂèñÊ∂à
          </button>
          <button 
            @click="saveNote"
            class="px-3 py-1.5 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded"
          >
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
      

   

      <div id="hs-overlay-right" class="hs-overlay hs-overlay-open:translate-x-0 hidden translate-x-full fixed top-0 end-0 transition-all duration-300 transform h-full max-w-xs w-full z-[4800] bg-white border-s dark:bg-neutral-800 dark:border-neutral-700" tabindex="-1">
        <div class="flex justify-between items-center py-3 px-4 border-b dark:border-neutral-700">
          <h3 class="font-bold text-gray-800 dark:text-white">
            Contents
          </h3>
          <button type="button" class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-neutral-700" data-hs-overlay="#hs-overlay-right">
            <span class="sr-only">Close modal</span>
            <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-4">
          <ul id="toc" class="space-y-2">
            <li v-for="(chapter, index) in toc" :key="index">
              <a href="#" @click.prevent="displayChapter(chapter.href, true)" class="text-blue-600 hover:text-blue-800">
                {{ chapter.label }}
              </a>
            </li>
          </ul>
        </div>
      </div>
    
    <CommonSidebar 
      ref="sidebar"
      :text="plainTextContent" 
      :summary="summaryText" 
      :isGeneratingSummary="isGeneratingSummary" 
      :visible="showSidebar" 
      @close="closeSidebarWithCancel"
    />

    <!-- ËÅäÂ§©ËæπÊ†è -->
    <div v-if="showChatSidebar" class="fixed top-0 right-0 h-full w-96 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-2xl z-[5000] flex flex-col">
      <!-- ËÅäÂ§©Â§¥ÈÉ® -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-green-500 to-blue-500">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-bold text-white">AIÂä©Êâã</h3>
            <p class="text-green-100 text-sm">Âü∫‰∫éGeminiÁöÑÊô∫ËÉΩÂØπËØù</p>
          </div>
        </div>
        <button @click="closeChatSidebar" class="text-white/80 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4" ref="chatMessagesContainer">
        <!-- Ê¨¢ËøéÊ∂àÊÅØ -->
        <div v-if="chatMessages.length === 0" class="text-center py-8">
          <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Ê¨¢Ëøé‰ΩøÁî®AIÂä©Êâã</h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm">ÊàëÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁêÜËß£ÂΩìÂâçÁ´†ËäÇÁöÑÂÜÖÂÆπÔºåÂõûÁ≠îÁõ∏ÂÖ≥ÈóÆÈ¢òÔºåÊàñËÄÖËøõË°åÂÖ∂‰ªñËÆ®ËÆ∫„ÄÇ</p>
        </div>

        <!-- ËÅäÂ§©Ê∂àÊÅØ -->
        <div v-for="(message, index) in chatMessages" :key="index" class="flex" :class="message.isUser ? 'justify-end' : 'justify-start'">
          <div class="max-w-[80%]">
            <!-- Áî®Êà∑Ê∂àÊÅØ -->
            <div v-if="message.isUser" class="bg-blue-500 text-white rounded-2xl rounded-br-md px-4 py-2 shadow-sm">
              <p class="text-sm">{{ message.content }}</p>
              <p class="text-xs text-blue-100 mt-1">{{ formatTime(message.timestamp) }}</p>
            </div>
            
            <!-- AIÊ∂àÊÅØ -->
            <div v-else class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-2xl rounded-bl-md px-4 py-2 shadow-sm">
              <p class="text-sm whitespace-pre-wrap">{{ message.content }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ formatTime(message.timestamp) }}</p>
            </div>
          </div>
        </div>

        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="isSendingMessage" class="flex justify-start">
          <div class="max-w-[80%]">
            <div class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-2xl rounded-bl-md px-4 py-2 shadow-sm">
              <div class="flex items-center space-x-2">
                <div class="flex space-x-1">
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
                <span class="text-xs text-gray-500 dark:text-gray-400">AIÊ≠£Âú®ÊÄùËÄÉ...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ËæìÂÖ•Âå∫Âüü -->
      <div class="border-t border-gray-200 dark:border-gray-700 p-4">
        <div class="flex space-x-2">
          <input
            v-model="currentChatMessage"
            @keydown.enter="sendMessage"
            type="text"
            placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..."
            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            :disabled="isSendingMessage"
          />
          <button
            @click="sendMessage"
            :disabled="!currentChatMessage.trim() || isSendingMessage"
            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- RelinkÂºπÁ™ó -->
    <RelinkModal
      :visible="showRelinkModal"
      :isLoading="relinkModalLoading"
      :error="relinkModalError"
      :results="relinkModalResults"
      @close="closeRelinkModal"
    />

    <!-- QuizÂºπÁ™ó -->
    <div v-if="showQuizModal" class="fixed inset-0 z-[6000] flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 overflow-hidden border border-gray-200 dark:border-gray-700">
        <!-- ÂºπÁ™óÂ§¥ÈÉ® -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Á´†ËäÇÂ∞èÊµãËØï</h2>
                <p class="text-blue-100 text-sm">ÊµãËØïÊÇ®ÂØπÊú¨Á´†ÂÜÖÂÆπÁöÑÁêÜËß£</p>
              </div>
            </div>
            <button @click="closeQuizModal" class="text-white/80 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- ÂºπÁ™óÂÜÖÂÆπ -->
        <div class="p-6">
          <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
          <div v-if="isGeneratingQuiz" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">Ê≠£Âú®ÁîüÊàêÂ∞èÊµãËØï...</p>
          </div>

          <!-- QuizÂÜÖÂÆπ -->
          <div v-else-if="quizData.length > 0 && !quizCompleted" class="space-y-6">
            <!-- ËøõÂ∫¶Êù° -->
            <div class="flex items-center justify-between mb-6">
              <div class="text-sm text-gray-600 dark:text-gray-300">
                ÈóÆÈ¢ò {{ currentQuizIndex + 1 }} / {{ quizData.length }}
              </div>
              <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" :style="{ width: ((currentQuizIndex + 1) / quizData.length * 100) + '%' }"></div>
              </div>
            </div>

            <!-- ÂΩìÂâçÈóÆÈ¢ò -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">
                {{ quizData[currentQuizIndex].question }}
              </h3>
              
              <!-- ÈÄâÈ°π -->
              <div class="space-y-3">
                <button
                  v-for="(choice, index) in quizData[currentQuizIndex].choices"
                  :key="index"
                  @click="selectAnswer(index)"
                  :class="[
                    'w-full text-left p-4 rounded-lg border-2 transition-all duration-200',
                    userAnswers[currentQuizIndex] === index
                      ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300'
                      : 'border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 text-gray-700 dark:text-gray-300'
                  ]"
                >
                  <div class="flex items-center">
                    <div class="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center"
                         :class="userAnswers[currentQuizIndex] === index ? 'border-blue-500 bg-blue-500' : 'border-gray-300 dark:border-gray-600'">
                      <span v-if="userAnswers[currentQuizIndex] === index" class="text-white text-xs">‚úì</span>
                    </div>
                    <span class="font-medium mr-2">{{ String.fromCharCode(65 + index) }}.</span>
                    <span>{{ choice }}</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- ÂØºËà™ÊåâÈíÆ -->
            <div class="flex justify-between">
              <button
                @click="previousQuestion"
                :disabled="currentQuizIndex === 0"
                class="px-6 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                ‰∏ä‰∏ÄÈ¢ò
              </button>
              
              <button
                v-if="currentQuizIndex < quizData.length - 1"
                @click="nextQuestion"
                :disabled="userAnswers[currentQuizIndex] === undefined"
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                ‰∏ã‰∏ÄÈ¢ò
              </button>
              
              <button
                v-else
                @click="submitQuiz"
                :disabled="userAnswers[currentQuizIndex] === undefined"
                class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Êèê‰∫§Á≠îÊ°à
              </button>
            </div>
          </div>

          <!-- ÁªìÊûúÈ°µÈù¢ -->
          <div v-else-if="quizCompleted" class="flex flex-col py-4" style="min-height:40vh;max-height:70vh;">
            <div class="mb-4">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center"
                   :class="quizScore >= 2 ? 'bg-green-100 dark:bg-green-900/20' : 'bg-red-100 dark:bg-red-900/20'">
                <svg v-if="quizScore >= 2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-green-600 dark:text-green-400">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-red-600 dark:text-red-400">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                {{ quizScore >= 2 ? 'ÊÅ≠ÂñúÔºÅ' : 'ÁªßÁª≠Âä†Ê≤πÔºÅ' }}
              </h3>
              <p class="text-gray-600 dark:text-gray-300">
                ÊÇ®ÁöÑÂæóÂàÜÔºö{{ quizScore }}/{{ quizData.length }}
              </p>
            </div>

            <!-- ËØ¶ÁªÜÁªìÊûúÂÜÖÂÆπÂèØÊªöÂä® -->
            <div class="flex-1 overflow-y-auto max-h-[40vh] space-y-4 mb-2 pr-2">
              <div v-for="(quiz, index) in quizData" :key="index" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                <div class="flex items-start justify-between mb-1">
                  <h4 class="font-medium text-gray-800 dark:text-gray-200">ÈóÆÈ¢ò {{ index + 1 }}</h4>
                  <div class="flex items-center">
                    <span v-if="userAnswers[index] === quiz.correctAnswer" class="text-green-600 dark:text-green-400 text-sm font-medium">‚úì Ê≠£Á°Æ</span>
                    <span v-else class="text-red-600 dark:text-red-400 text-sm font-medium">‚úó ÈîôËØØ</span>
                  </div>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-2">{{ quiz.question }}</p>
                <div class="space-y-1">
                  <div v-for="(choice, choiceIndex) in quiz.choices" :key="choiceIndex"
                       :class="[
                         'text-sm p-2 rounded',
                         choiceIndex === quiz.correctAnswer
                           ? 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800'
                           : choiceIndex === userAnswers[index] && choiceIndex !== quiz.correctAnswer
                           ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800'
                           : 'text-gray-600 dark:text-gray-400'
                       ]">
                    <span class="font-medium">{{ String.fromCharCode(65 + choiceIndex) }}.</span> {{ choice }}
                    <span v-if="choiceIndex === quiz.correctAnswer" class="ml-2 text-xs">(Ê≠£Á°ÆÁ≠îÊ°à)</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆÂõ∫ÂÆöÂú®Â∫ïÈÉ® -->
            <div class="flex justify-center space-x-4 border-t pt-4 mt-2 bg-white dark:bg-gray-800 sticky bottom-0 z-10">
              <button @click="retakeQuiz" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                ÈáçÊñ∞ÊµãËØï
              </button>
              <button @click="closeQuizModal" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                ÂÖ≥Èó≠
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÈòÖËØªËøõÂ∫¶ÊèêÈÜíÂºπÁ™ó -->
    <div v-if="showReadingProgressModal" class="fixed inset-0 z-[6000] flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden border border-gray-200 dark:border-gray-700">
        <!-- ÂºπÁ™óÂ§¥ÈÉ® -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">ÈòÖËØªËøõÂ∫¶ÊèêÈÜí</h2>
                <p class="text-blue-100 text-sm">ÁªßÁª≠ÊÇ®ÁöÑÈòÖËØª‰πãÊóÖ</p>
              </div>
            </div>
            <button @click="closeReadingProgressModal" class="text-white/80 hover:text-white transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- ÂºπÁ™óÂÜÖÂÆπ -->
        <div class="p-6 space-y-6">
          <!-- ‰∏äÊ¨°ÈòÖËØªÊó∂Èó¥ -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center space-x-2 mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 dark:text-gray-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm font-medium text-gray-600 dark:text-gray-300">‰∏äÊ¨°ÈòÖËØªÊó∂Èó¥</span>
            </div>
            <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">{{ formatLastReadingTime() }}</p>
          </div>

          <!-- ‰∏äÊ¨°ÈòÖËØªÂÜÖÂÆπ -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border-l-4 border-blue-500">
            <div class="flex items-center space-x-2 mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-blue-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
              <span class="text-sm font-medium text-blue-600 dark:text-blue-400">‰∏äÊ¨°ÈòÖËØªÊÄªÁªì</span>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded p-3 border min-h-[48px]">
              <template v-if="isGeneratingGeminiSummary">
                <span class="text-gray-400 dark:text-gray-500">AIÊÄªÁªìÁîüÊàê‰∏≠...</span>
              </template>
              <template v-else>
                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ lastReadingSummary || 'ÊöÇÊó†ÊÄªÁªì' }}</p>
              </template>
            </div>
          </div>

          <!-- ÈòÖËØªÁªüËÆ° -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ lastReadingInfo?.progress || 0 }}%</div>
              <div class="text-sm text-green-600 dark:text-green-400">ÈòÖËØªËøõÂ∫¶</div>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ lastReadingInfo?.duration || 0 }}ÂàÜÈíü</div>
              <div class="text-sm text-purple-600 dark:text-purple-400">ÈòÖËØªÊó∂Èïø</div>
            </div>
          </div>
        </div>

        <!-- ÂºπÁ™óÂ∫ïÈÉ® -->
        <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 flex justify-end space-x-3">
          <button @click="closeReadingProgressModal" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 transition-colors">
            Á®çÂêéÊü•Áúã
          </button>
          <button @click="continueReading" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-medium">
            ÁªßÁª≠ÈòÖËØª
          </button>
        </div>
      </div>
    </div>

  </div>

</template>

<script>
import ePub from 'epubjs'
import localforage from 'localforage'
import CommonSidebar from '../components/common/Sidebar.vue'
import RelinkModal from '../components/common/RelinkModal.vue'
import { GoogleGenAI } from '@google/genai'

export default {
  name: 'BookReader',
  components: {
    CommonSidebar,
    RelinkModal
  },
  props: {
    fileName: {
      type: String,
      required: true
    }
  },
  data() {
    return {
      book: null,
      rendition: null,
      toc: [],
      resizeTimeout: null,
      isResizing: false,
      showSidebar: false,
      plainTextContent: '',
      summaryText: '',
      isGeneratingSummary: false,
      currentChapterId: '', // ÂΩìÂâçÁ´†ËäÇID
      currentAbortController: null, // ÂΩìÂâçAPIËØ∑Ê±ÇÁöÑAbortController
      bookTitle: '', // ‰π¶Á±çÊ†áÈ¢ò
      geminiApiKey: process.env.VUE_APP_GEMINI_API_KEY, // Áî®Êà∑ÈúÄË¶ÅÂ°´ÂÜôËá™Â∑±ÁöÑAPI key
      ai: null, // GoogleGenAI ÂÆû‰æã
      showContextMenu: false,
      contextMenuPosition: { x: 0, y: 0 },
      selectedText: '',
      highlights: [], // Â≠òÂÇ®È´ò‰∫Æ‰ø°ÊÅØ
      isRestoringHighlights: false, // Èò≤Ê≠¢ÈáçÂ§çÊÅ¢Â§çÈ´ò‰∫ÆÁöÑÊ†áÂøó
      shouldRestoreHighlights: false, // ÊéßÂà∂ÊòØÂê¶Â∫îËØ•ÊÅ¢Â§çÈ´ò‰∫Æ
      isHoveringHighlight: false, // ÊòØÂê¶ÊÇ¨ÂÅúÂú®È´ò‰∫Æ‰∏ä
      hoveredHighlightId: null, // ÊÇ¨ÂÅúÁöÑÈ´ò‰∫ÆID
      showNoteInput: false, // ÊòØÂê¶ÊòæÁ§∫Á¨îËÆ∞ËæìÂÖ•Ê°Ü
      noteInputPosition: { x: 0, y: 0 }, // Á¨îËÆ∞ËæìÂÖ•Ê°Ü‰ΩçÁΩÆ
      currentNoteText: '', // ÂΩìÂâçÁ¨îËÆ∞ÊñáÊú¨
      currentHighlightId: null, // ÂΩìÂâçÊìç‰ΩúÁöÑÈ´ò‰∫ÆID
      // ÈòÖËØªËøõÂ∫¶Ë∑üË∏™
      showReadingProgressModal: false,
      lastReadingInfo: null,
      currentReadingContent: '',
      contextMenuHovering: false, // Èº†Ê†áÊòØÂê¶Âú®ËèúÂçï‰∏ä
      noteInputHovering: false, // Èº†Ê†áÊòØÂê¶Âú®Á¨îËÆ∞ËæìÂÖ•Ê°Ü‰∏ä
      showRelinkModal: false, // ÊòØÂê¶ÊòæÁ§∫RelinkÂºπÁ™ó
      relinkModalLoading: false, // RelinkÂºπÁ™óÂä†ËΩΩÁä∂ÊÄÅ
      relinkModalError: '', // RelinkÂºπÁ™óÈîôËØØ‰ø°ÊÅØ
      relinkModalResults: [], // RelinkÂºπÁ™óÊêúÁ¥¢ÁªìÊûú
      isGeneratingQuiz: false, // ÊòØÂê¶Ê≠£Âú®ÁîüÊàêÂ∞èÊµãËØï
      showQuizModal: false, // ÊòØÂê¶ÊòæÁ§∫QuizÂºπÁ™ó
      quizData: [], // QuizÊï∞ÊçÆ
      currentQuizIndex: 0, // ÂΩìÂâçQuizÁ¥¢Âºï
      userAnswers: [], // Áî®Êà∑Á≠îÊ°à
      quizCompleted: false, // QuizÊòØÂê¶ÂÆåÊàê
      quizScore: 0, // QuizÂæóÂàÜ
      showChatSidebar: false, // ÊòØÂê¶ÊòæÁ§∫ËÅäÂ§©ËæπÊ†è
      chatMessages: [], // ËÅäÂ§©Ê∂àÊÅØ
      currentChatMessage: '', // ÂΩìÂâçËæìÂÖ•ÁöÑÊ∂àÊÅØ
      isSendingMessage: false, // ÊòØÂê¶Ê≠£Âú®ÂèëÈÄÅÊ∂àÊÅØ
      lastReadingSummary: '', // Êñ∞Â¢ûÔºö‰∏äÊ¨°ÈòÖËØªÊÄªÁªì
      isGeneratingGeminiSummary: false, // Êñ∞Â¢ûÔºöGeminiÁîüÊàêÁä∂ÊÄÅ
    }
  },
  methods: {
    async loadBook() {
      try {
        const bookItem = await localforage.getItem(this.fileName);
        if (bookItem && bookItem.data) {
          this.book = ePub(bookItem.data);

          this.rendition = this.book.renderTo("viewer", {
            flow: "scrolled-doc", // Â∞Ü flow ËÆæÁΩÆ‰∏∫ paginated
            width: "100%",
            height: "100%",
            fullsize: true,
          });

          this.defineHooks();
          await this.loadTOC(); 
          await this.displayBook();

          // Set the book title
          const metadata = await this.book.loaded.metadata;
          const fullTitle = metadata.title;
          const truncatedTitle = fullTitle.split(':')[0].trim();
          this.bookTitle = truncatedTitle; // ‰øùÂ≠ò‰π¶Á±çÊ†áÈ¢ò
          document.getElementById('book-title').textContent = truncatedTitle;

          // ÂàùÂßãÂåñ GoogleGenAI ÂÆû‰æã
          this.ai = new GoogleGenAI({ apiKey: this.geminiApiKey });

          // ÊèêÂèñÁ∫ØÊñáÊú¨ÂÜÖÂÆπ
          this.extractPlainText();
          
          // ÂàùÂßãÂä†ËΩΩÊó∂ÊÅ¢Â§çÈ´ò‰∫Æ
          this.shouldRestoreHighlights = true;
          this.restoreHighlights();
          this.shouldRestoreHighlights = false;
          
          // Ê£ÄÊü•ÈòÖËØªËøõÂ∫¶Âπ∂ÊòæÁ§∫ÊèêÈÜí
          this.checkReadingProgress();
        } else {
          console.error('Book not found in local storage or invalid book data');
          this.$router.push({ name: 'Home' });
        }
      } catch (error) {
        console.error('Error loading book:', error);
        this.$router.push({ name: 'Home' });
      }
    },
    
    handleKeydown(event) {
      if (event.key === 'ArrowLeft') {
        this.goPrev(event);
      } else if (event.key === 'ArrowRight') {
        this.goNext(event);
      } else if (event.key === 'Escape') {
        this.goHome();
      }
    },
    
    defineHooks() {
      this.book.rendition.hooks.content.register((contents) => {
        let doc = contents.document;
        let head = doc.querySelector('head');

        // Remove existing stylesheets
        Array.from(head.querySelectorAll('link[rel="stylesheet"], style'))
          .forEach(el => el.remove());

          // Modify links
          const links = doc.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (href) {
            if (href.startsWith('http://') || href.startsWith('https://')) {
              // External link: open in new tab
              link.setAttribute('target', '_blank');
            } else {  
              // Internal link: remove href and make it non-clickable
              link.removeAttribute('href');
              link.style.textDecoration = 'none';
              link.style.color = 'inherit';
              link.style.cursor = 'text';
            }
          }
        });


        // Inject minimal Tailwind styles
        let style = doc.createElement('style');
        style.textContent = this.getMinimalTailwindStyles();
        head.appendChild(style);

        // Remove empty paragraphs
        var paras = doc.getElementsByTagName('p');
        for (var i = paras.length - 1; i >= 0; i--) {
          if (paras[i].innerHTML.replace(/\s|&nbsp;/g, '').length == 0)
            paras[i].parentNode.removeChild(paras[i]);
        }
        // Convert all-caps headings to sentence case
        this.convertAllCapsHeadings(doc);

        // Add Tailwind-like typography classes to body
        doc.body.classList.add('prose', 'mx-auto', 'px-4');

        // Apply dark mode styles
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          doc.body.classList.add('dark');
        }

        // Ê∑ªÂä†ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨Âô®
        doc.removeEventListener('mouseup', this.handleTextSelection);
        doc.removeEventListener('click', (event) => this.hideContextMenu(event));
        
        doc.addEventListener('mouseup', this.handleTextSelection);
        doc.addEventListener('click', (event) => this.hideContextMenu(event));
        
        // ‰∏∫È´ò‰∫ÆÂÖÉÁ¥†Ê∑ªÂä†ÊÇ¨ÂÅú‰∫ã‰ª∂
        this.addHighlightHoverEvents(doc);
        
        // ÂÜÖÂÆπÊ∏≤ÊüìÂÆåÊàêÂêéÊÅ¢Â§çÂΩìÂâçÈ°µÈù¢ÁöÑÈ´ò‰∫ÆÔºà‰ªÖÂú®ÁøªÈ°µÊàñÈáçÊñ∞ËøõÂÖ•Êó∂Ôºâ
        if (this.shouldRestoreHighlights) {
          setTimeout(() => {
            this.restoreHighlightsForCurrentPage();
          }, 100);
        }
      });

      this.rendition.on("relocated", (location) => {
        localStorage.setItem(`epub-location-${this.fileName}`, location.start.cfi);
        // ‰∏çÂÜçÂú®ËøôÈáåÊõ¥Êñ∞Á´†ËäÇIDÔºåÂè™Âú®ÁøªÈ°µÊó∂Êõ¥Êñ∞
      });
    },
    convertAllCapsHeadings(doc) {
      const headings = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach(heading => {
        if (this.isAllCaps(heading.textContent)) {
          heading.textContent = this.toSentenceCase(heading.textContent);
        }
      });
    },

    isAllCaps(text) {
      return text === text.toUpperCase() && text !== text.toLowerCase();
    },

    toSentenceCase(text) {
      return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
    },

    handleInternalLink(href) {
      if (href.startsWith('#')) {
        // It's an anchor within the current chapter
        this.rendition.display(href);
      } else {
        // It's a link to another chapter
        const item = this.book.spine.get(href);
        if (item) {
          this.rendition.display(item.href);
        } else {
          console.error(`Unable to find item for href: ${href}`);
        }
      }
    },

    getMinimalTailwindStyles() {
      return `
        @import url('https://fonts.googleapis.com/css2?family=Gentium+Book+Plus:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        .prose { 
          font-family: 'Gentium Book Plus', sans-serif; 
          font-size: 20px;
          line-height: 180%;}
        .prose p { margin-bottom: 1em; }
        .prose h1, .prose h2, .prose h3, .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; }
        .prose h1 { font-size: 2.25em; line-height: 120%; }
        .prose h2 { font-size: 1.5em; line-height: 120%;}
        .prose h3 { font-size: 1.25em; line-height: 120%;}
        .prose h4 { font-size: 1.2em; line-height: 120%;}
        .prose strong {font-weight: 700; }
        .prose a { color: #333; text-decoration: none; }
        .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
        .prose li { margin-bottom: 0.25em; }
        .prose li p { margin: 0;}
        .prose img { 
        margin-top: 1em; margin-bottom: 1em; 
        width: 80%;
        height: 100%;
        margin-left:auto;
        margin-right:auto;}
        @media (prefers-color-scheme: dark) {
          body.dark { background-color: #000; color: #e2e8f0; }
          body.dark a { color: #e2e8f0; }
        }
        
        /* È´ò‰∫ÆÊ†∑Âºè */
        .epub-highlight {
          background-color: #fef08a !important;
          color: #000 !important;
        }
      `;
    },

    goNext(event) {
      event.preventDefault();
      
      // ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç
      this.cancelCurrentSummaryRequest();
      
      this.rendition.next();
      this.$nextTick(() => {
        // Êõ¥Êñ∞ÂΩìÂâçÁ´†ËäÇID
        const currentLocation = this.rendition.currentLocation();
        if (currentLocation && currentLocation.start) {
          this.currentChapterId = this.generateChapterId(currentLocation);
          console.log('ÁøªÈ°µÂêéÁ´†ËäÇIDÊõ¥Êñ∞:', this.currentChapterId);
        }
        
        this.extractPlainText();
        // ÁøªÈ°µÂêéÂª∂ËøüÊÅ¢Â§çÈ´ò‰∫ÆÔºåÈÅøÂÖçÂπ≤Êâ∞ÁøªÈ°µ
        setTimeout(() => {
          this.shouldRestoreHighlights = true;
          this.restoreHighlightsForCurrentPage();
          this.shouldRestoreHighlights = false;
        }, 300);
        // ‰øùÂ≠òÈòÖËØªËøõÂ∫¶
        this.saveReadingProgress();
      });
    },

    goPrev(event) {
      event.preventDefault();
      
      // ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç
      this.cancelCurrentSummaryRequest();
      
      this.rendition.prev();
      this.$nextTick(() => {
        // Êõ¥Êñ∞ÂΩìÂâçÁ´†ËäÇID
        const currentLocation = this.rendition.currentLocation();
        if (currentLocation && currentLocation.start) {
          this.currentChapterId = this.generateChapterId(currentLocation);
          console.log('ÁøªÈ°µÂêéÁ´†ËäÇIDÊõ¥Êñ∞:', this.currentChapterId);
        }
        
        this.extractPlainText();
        // ÁøªÈ°µÂêéÂª∂ËøüÊÅ¢Â§çÈ´ò‰∫ÆÔºåÈÅøÂÖçÂπ≤Êâ∞ÁøªÈ°µ
        setTimeout(() => {
          this.shouldRestoreHighlights = true;
          this.restoreHighlightsForCurrentPage();
          this.shouldRestoreHighlights = false;
        }, 300);
        // ‰øùÂ≠òÈòÖËØªËøõÂ∫¶
        this.saveReadingProgress();
      });
    },

    async loadTOC() {
      const navigation = await this.book.loaded.navigation;
      this.toc = navigation.toc;
    },

    async displayBook() {
      try {
        const savedLocation = localStorage.getItem(`epub-location-${this.fileName}`);
        const currentSectionIndex = savedLocation || undefined;
        await this.rendition.display(currentSectionIndex);
        
        // ËÆæÁΩÆÂΩìÂâçÁ´†ËäÇID
        const currentLocation = this.rendition.currentLocation();
        if (currentLocation && currentLocation.start) {
          this.currentChapterId = this.generateChapterId(currentLocation);
          console.log('ÂàùÂßãÁ´†ËäÇIDËÆæÁΩÆ:', this.currentChapterId);
        }
        
        // ÂàáÊç¢Á´†ËäÇÊó∂‰πüÊèêÂèñÁ∫ØÊñáÊú¨
        this.extractPlainText();
      } catch (error) {
        console.error('Error displaying book:', error);
      }
    },
    extractPlainText() {
      // Ëé∑ÂèñÂΩìÂâçÊ∏≤ÊüìÁöÑiframeÊàñÂÜÖÂÆπÂå∫ÂüüÁöÑÁ∫ØÊñáÊú¨
      const viewer = document.getElementById('viewer');
      if (!viewer) return;
      // epubjs‰ºöÂú®viewer‰∏ãÊèíÂÖ•iframeÊàñdiv
      let text = '';
      const iframes = viewer.getElementsByTagName('iframe');
      if (iframes.length > 0) {
        // Â§öÁ´†ËäÇscrolledÊ®°Âºè‰∏ãÂèØËÉΩÊúâÂ§ö‰∏™iframe
        for (let iframe of iframes) {
          try {
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            if (doc && doc.body) {
              text += doc.body.innerText + '\n';
            }
          } catch (e) {
            console.log(e)
          }
        }
      } else {
        // ‰πüÂèØËÉΩÁõ¥Êé•Ê∏≤Êüìdiv
        text = viewer.innerText;
      }
      this.plainTextContent = text.trim();
      // Â¶ÇÊûúËæπÊ†èÂºÄÂêØÔºåÂ∞±Ê£ÄÊü•ÊëòË¶ÅÔºàÊ∑ªÂä†Âª∂ËøüÁ≠âÂæÖÂÜÖÂÆπÊõ¥Êñ∞Ôºâ
      if (this.showSidebar) {
        // Âª∂ËøüÊ£ÄÊü•ÊëòË¶ÅÔºåÁ≠âÂæÖÂÜÖÂÆπÂÆåÂÖ®Êõ¥Êñ∞
        setTimeout(() => {
          this.checkCurrentChapterSummary();
        }, 500);
      }
    },
    // Ê£ÄÊü•ÂΩìÂâçÁ´†ËäÇÊëòË¶Å
    checkCurrentChapterSummary() {
      // ÈáçÊñ∞Ëé∑ÂèñÂΩìÂâçÁ´†ËäÇIDÔºåÁ°Æ‰øùËé∑ÂèñÂà∞ÊúÄÊñ∞ÁöÑ
      const currentLocation = this.rendition.currentLocation();
      if (currentLocation && currentLocation.start) {
        this.currentChapterId = this.generateChapterId(currentLocation);
        console.log('Âª∂ËøüÊ£ÄÊü•ÊëòË¶ÅÔºåÊõ¥Êñ∞Á´†ËäÇID:', this.currentChapterId);
      }
      
      if (!this.currentChapterId) {
        console.log('ÂΩìÂâçÁ´†ËäÇIDÊú™ËÆæÁΩÆÔºåË∑≥ËøáÊëòË¶ÅÊ£ÄÊü•');
        return;
      }
      
      // ËÆæÁΩÆÁîüÊàê‰∏≠Áä∂ÊÄÅ
      this.isGeneratingSummary = true;
      this.summaryText = '';
      
      // Â∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÂΩìÂâçÁ´†ËäÇÁöÑÊëòË¶Å
      const summary = this.loadChapterSummary(this.currentChapterId);
      
      if (summary) {
        // Â¶ÇÊûúÊâæÂà∞Â∑≤‰øùÂ≠òÁöÑÊëòË¶ÅÔºåÂª∂Êó∂1ÁßíÂêéÊòæÁ§∫
        console.log('Â∑≤Âä†ËΩΩÁ´†ËäÇÊëòË¶Å:', this.currentChapterId);
        setTimeout(async () => {
          this.summaryText = summary;
          this.isGeneratingSummary = false;
          
          // ÂèëÈÄÅÊëòË¶ÅÂà∞API
          const result = await this.submitSummaryToAPI(summary);
          if (result.success) {
            console.log('Â∑≤‰øùÂ≠òÊëòË¶ÅÂèëÈÄÅÂà∞APIÊàêÂäü');
          } else {
            console.error('Â∑≤‰øùÂ≠òÊëòË¶ÅÂèëÈÄÅÂà∞APIÂ§±Ë¥•:', result.error);
          }
          
          // ÊëòË¶ÅÊòæÁ§∫ÂÆåÊàêÂêéÔºåÊêúÁ¥¢Áõ∏ÂÖ≥Áü•ËØÜÁÇπ
          await this.searchWithSummary(summary);
        }, 1000);
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÊëòË¶ÅÔºåÁîüÊàêÊñ∞ÁöÑ
        console.log('Êú™ÊâæÂà∞Á´†ËäÇÊëòË¶ÅÔºåÂºÄÂßãÁîüÊàê:', this.currentChapterId);
        this.generateSummary();
      }
    },

    async generateSummary() {
      if (!this.plainTextContent || !this.ai) {
        this.summaryText = 'ËØ∑ÂÖàËÆæÁΩÆGemini API Key';
        this.isGeneratingSummary = false;
        return;
      }
      
      // ÂèñÊ∂à‰πãÂâçÁöÑËØ∑Ê±Ç
      this.cancelCurrentSummaryRequest();
      
      // ÂàõÂª∫Êñ∞ÁöÑAbortController
      this.currentAbortController = new AbortController();
      const currentController = this.currentAbortController;
      const currentChapterId = this.currentChapterId;
      
      console.log('ÂºÄÂßãÁîüÊàêÊëòË¶ÅÔºåÁ´†ËäÇID:', currentChapterId);
      
      try {
        // ‰ΩøÁî®AbortControllerÂåÖË£ÖAPIËØ∑Ê±Ç
        const response = await this.ai.models.generateContent({
          model: "gemini-2.0-flash-exp",
          contents: `Summarize those content within 100 words:\n\n${this.plainTextContent}`
        }, {
          signal: currentController.signal
        });
        
        // Ê£ÄÊü•ËØ∑Ê±ÇÊòØÂê¶Â∑≤Ë¢´ÂèñÊ∂à
        if (currentController.signal.aborted) {
          console.log('ÊëòË¶ÅÁîüÊàêËØ∑Ê±ÇÂ∑≤Ë¢´ÂèñÊ∂àÔºåÁ´†ËäÇID:', currentChapterId);
          return;
        }
        
        // Ê£ÄÊü•Á´†ËäÇIDÊòØÂê¶‰ªçÁÑ∂ÂåπÈÖç
        if (this.currentChapterId !== currentChapterId) {
          console.log('Á´†ËäÇÂ∑≤ÂàáÊç¢ÔºåÂøΩÁï•ÊóßÁöÑÊëòË¶ÅÁªìÊûúÔºåÁ´†ËäÇID:', currentChapterId);
          return;
        }
        
        console.log('ÊëòË¶ÅÁîüÊàêÂÆåÊàêÔºåÁ´†ËäÇID:', currentChapterId);
        this.summaryText = response.text;
        
        // ‰øùÂ≠òÂΩìÂâçÁ´†ËäÇÁöÑÊëòË¶Å
        this.saveChapterSummary(this.currentChapterId, response.text);
        
        // ÂèëÈÄÅÊñ∞ÁîüÊàêÁöÑÊëòË¶ÅÂà∞API
        const result = await this.submitSummaryToAPI(response.text);
        if (result.success) {
          console.log('Êñ∞ÁîüÊàêÊëòË¶ÅÂèëÈÄÅÂà∞APIÊàêÂäü');
        } else {
          console.error('Êñ∞ÁîüÊàêÊëòË¶ÅÂèëÈÄÅÂà∞APIÂ§±Ë¥•:', result.error);
        }
        
        // ÊëòË¶ÅÁîüÊàêÂÆåÊàêÂêéÔºåÊêúÁ¥¢Áõ∏ÂÖ≥Áü•ËØÜÁÇπ
        await this.searchWithSummary(response.text);
      } catch (error) {
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂèñÊ∂àÈîôËØØ
        if (error.name === 'AbortError') {
          console.log('ÊëòË¶ÅÁîüÊàêËØ∑Ê±ÇÂ∑≤Ë¢´ÂèñÊ∂àÔºàAbortErrorÔºâÔºåÁ´†ËäÇID:', currentChapterId);
          return;
        }
        
        // Ê£ÄÊü•Á´†ËäÇIDÊòØÂê¶‰ªçÁÑ∂ÂåπÈÖç
        if (this.currentChapterId !== currentChapterId) {
          console.log('Á´†ËäÇÂ∑≤ÂàáÊç¢ÔºåÂøΩÁï•ÈîôËØØÁªìÊûúÔºåÁ´†ËäÇID:', currentChapterId);
          return;
        }
        
        console.error('ÁîüÊàêÊëòË¶ÅÊó∂Âá∫Èîô:', error);
        this.summaryText = 'ÁîüÊàêÊëòË¶ÅÊó∂Âá∫ÈîôÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
      } finally {
        // Âè™ÊúâÂΩìÂâçÊéßÂà∂Âô®‰ªçÁÑ∂ÂåπÈÖçÊó∂ÊâçÈáçÁΩÆÁä∂ÊÄÅ
        if (this.currentAbortController === currentController) {
          this.isGeneratingSummary = false;
          this.currentAbortController = null;
        }
      }
    },

    saveCurrentLocation() {
      if (this.rendition) {
        const currentLocation = this.rendition.currentLocation();
        if (currentLocation && currentLocation.start) {
          localStorage.setItem(`epub-location-${this.fileName}`, currentLocation.start.cfi);
        }
      }
      // ÂêåÊó∂‰øùÂ≠òÈòÖËØªËøõÂ∫¶
      this.saveReadingProgress();
    },

    displayChapter(href) {
      if (this.rendition) {
        // ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç
        this.cancelCurrentSummaryRequest();
        
        this.closeSidebar();  
        this.rendition.display(href);
        this.$nextTick(() => {
          // Êõ¥Êñ∞ÂΩìÂâçÁ´†ËäÇID
          const currentLocation = this.rendition.currentLocation();
          if (currentLocation && currentLocation.start) {
            this.currentChapterId = this.generateChapterId(currentLocation);
            console.log('ÂàáÊç¢Á´†ËäÇIDÊõ¥Êñ∞:', this.currentChapterId);
          }
          
          this.extractPlainText();
          // Ë∑≥ËΩ¨Á´†ËäÇÂêéÂª∂ËøüÊÅ¢Â§çÈ´ò‰∫Æ
          setTimeout(() => {
            this.shouldRestoreHighlights = true;
            this.restoreHighlightsForCurrentPage();
            this.shouldRestoreHighlights = false;
          }, 500);
        });
      }
    },


    openSidebar() {
      document.getElementById('toc-sidebar').classList.remove('translate-x-full');
      document.getElementById('overlay').classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    },

    closeSidebar() {
   // Use the third-party library to close the sidebar
   if (window.HSOverlay) {
        window.HSOverlay.close(document.querySelector('#hs-overlay-right'));
      } else {
        console.warn('HSOverlay not found. Make sure the library is properly loaded.');
      }
    },

    // ÊâìÂºÄËæπÊ†èÂπ∂Â§ÑÁêÜÊëòË¶Å
    openSidebarWithSummary() {
      // ÊòæÁ§∫ËæπÊ†è
      this.showSidebar = true;
      
      // Â¶ÇÊûúÂΩìÂâçÂ∑≤ÁªèÊúâÊñáÊú¨ÂÜÖÂÆπÔºåÂª∂ËøüÊ£ÄÊü•ÊëòË¶Å
      if (this.plainTextContent) {
        setTimeout(() => {
          this.checkCurrentChapterSummary();
        }, 500);
      }
    },

    // ÂÖ≥Èó≠ËæπÊ†èÂπ∂ÂèñÊ∂àÊëòË¶ÅËØ∑Ê±Ç
    closeSidebarWithCancel() {
      // ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç
      this.cancelCurrentSummaryRequest();
      
      // ÂÖ≥Èó≠ËæπÊ†è
      this.showSidebar = false;
    },

    // ÂèëÈÄÅÊëòË¶ÅÂà∞API
    async submitSummaryToAPI(summary) {
      try {
        const formData = new FormData();
        formData.append('project_name', 'Hobby and Life');
        formData.append('article_title', this.bookTitle);
        formData.append('summary', summary);
        formData.append('chapter', this.currentChapterId);

        console.log('ÂèëÈÄÅÊëòË¶ÅÂà∞API:', {
          project_name: 'Hobby and Life',
          article_title: this.bookTitle,
          summary: summary,
          chapter: this.currentChapterId
        });

        const response = await fetch('https://graph-service.zeabur.app/submitsummary', {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
          },
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          console.log('ÊëòË¶ÅÊèê‰∫§ÊàêÂäü:', result);
          return { success: true, data: result };
        } else {
          console.error('ÊëòË¶ÅÊèê‰∫§Â§±Ë¥•:', response.status, response.statusText);
          return { success: false, error: `HTTP ${response.status}: ${response.statusText}` };
        }
      } catch (error) {
        console.error('ÂèëÈÄÅÊëòË¶ÅÂà∞APIÊó∂Âá∫Èîô:', error);
        return { success: false, error: error.message };
      }
    },

    // ÊêúÁ¥¢Áõ∏ÂÖ≥Áü•ËØÜÁÇπ
    async searchWithSummary(summary) {
      if (!summary || !this.$refs.sidebar) {
        console.log('ÊëòË¶Å‰∏∫Á©∫ÊàñsidebarÊú™ÊâæÂà∞ÔºåË∑≥ËøáÊêúÁ¥¢');
        return;
      }

      console.log('ÂºÄÂßãÊêúÁ¥¢Áõ∏ÂÖ≥Áü•ËØÜÁÇπÔºåÊëòË¶ÅÈïøÂ∫¶:', summary.length);
      
      // ËÆæÁΩÆsidebarÁöÑÂä†ËΩΩÁä∂ÊÄÅ
      this.$refs.sidebar.setRelinkLoading(true);
      
      try {
        const formData = new FormData();
        const limitedQuery = summary.length > 200 ? summary.substring(0, 200) + '...' : summary;
        formData.append('query', limitedQuery);
        formData.append('project_name', 'Hobby and Life');
        
        const response = await fetch('https://graph-service.zeabur.app/search', {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
          },
          body: formData
        });
        
        if (response.status === 200) {
          const data = await response.json();
          console.log('ÊêúÁ¥¢ÊàêÂäüÔºåÁªìÊûúÊï∞Èáè:', data.results ? data.results.length : 0);
          // Êõ¥Êñ∞sidebarÁöÑÊêúÁ¥¢ÁªìÊûú
          this.$refs.sidebar.updateRelinkResults(data);
        } else {
          console.error('ÊêúÁ¥¢ËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
          this.$refs.sidebar.setRelinkError(`ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
        }
      } catch (error) {
        console.error('ÊêúÁ¥¢Êó∂Âá∫Èîô:', error);
        this.$refs.sidebar.setRelinkError(`ÁΩëÁªúÈîôËØØ: ${error.message}`);
      }
    },

    // ÂèëÈÄÅÁ¨îËÆ∞Âà∞API
    async submitNoteToAPI(origin, comment) {
      try {
        const formData = new FormData();
        formData.append('project_name', 'Hobby and Life');
        formData.append('article_title', this.bookTitle || 'Unknown Book');
        formData.append('origin', origin);
        formData.append('comment', comment || '');
        
        console.log('ÂèëÈÄÅÁ¨îËÆ∞Âà∞API:', {
          project_name: 'Hobby and Life',
          article_title: this.bookTitle,
          origin: origin,
          comment: comment
        });

        const response = await fetch('https://graph-service.zeabur.app/submitnote', {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
          },
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Á¨îËÆ∞Êèê‰∫§ÊàêÂäü:', result);
          return { success: true, data: result };
        } else {
          console.error('Á¨îËÆ∞Êèê‰∫§Â§±Ë¥•:', response.status, response.statusText);
          return { success: false, error: `HTTP ${response.status}: ${response.statusText}` };
        }
      } catch (error) {
        console.error('ÂèëÈÄÅÁ¨îËÆ∞Âà∞APIÊó∂Âá∫Èîô:', error);
        return { success: false, error: error.message };
      }
    },

    // ÊòæÁ§∫È´ò‰∫ÆÁöÑRelinkÂºπÁ™ó
    async showRelinkForHighlight() {
      if (!this.hoveredHighlightId) {
        console.log('Ê≤°ÊúâÈ´ò‰∫ÆIDÔºåÊó†Ê≥ïÊòæÁ§∫Relink');
        return;
      }

      // Ëé∑ÂèñÈ´ò‰∫Æ‰ø°ÊÅØ
      const highlight = this.highlights.find(h => h.id === this.hoveredHighlightId);
      if (!highlight) {
        console.log('Êú™ÊâæÂà∞È´ò‰∫Æ‰ø°ÊÅØ');
        return;
      }

      // ÊòæÁ§∫ÂºπÁ™óÂπ∂ÂºÄÂßãÊêúÁ¥¢
      this.showRelinkModal = true;
      this.relinkModalLoading = true;
      this.relinkModalError = '';
      this.relinkModalResults = [];

      // ÊûÑÂª∫ÊêúÁ¥¢Êü•ËØ¢ÔºöÂéüÊñá + Á¨îËÆ∞ÔºàÂ¶ÇÊûúÊúâÔºâ
      let searchQuery = highlight.text;
      if (highlight.note) {
        searchQuery += ' ' + highlight.note;
      }

      console.log('ÂºÄÂßãRelinkÊêúÁ¥¢ÔºåÊü•ËØ¢:', searchQuery);

      try {
        const formData = new FormData();
        const limitedQuery = searchQuery.length > 200 ? searchQuery.substring(0, 200) + '...' : searchQuery;
        formData.append('query', limitedQuery);
        formData.append('project_name', 'Hobby and Life');
        
        const response = await fetch('https://graph-service.zeabur.app/search', {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
          },
          body: formData
        });
        
        if (response.status === 200) {
          const data = await response.json();
          console.log('RelinkÊêúÁ¥¢ÊàêÂäüÔºåÁªìÊûúÊï∞Èáè:', data.results ? data.results.length : 0);
          this.relinkModalResults = this.formatRelinkResults(data);
        } else {
          console.error('RelinkÊêúÁ¥¢ËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
          this.relinkModalError = `ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`;
        }
      } catch (error) {
        console.error('RelinkÊêúÁ¥¢Êó∂Âá∫Èîô:', error);
        this.relinkModalError = `ÁΩëÁªúÈîôËØØ: ${error.message}`;
      } finally {
        this.relinkModalLoading = false;
      }
    },

    // ÂÖ≥Èó≠RelinkÂºπÁ™ó
    closeRelinkModal() {
      this.showRelinkModal = false;
      this.relinkModalLoading = false;
      this.relinkModalError = '';
      this.relinkModalResults = [];
    },

    // Ê†ºÂºèÂåñRelinkÁªìÊûú
    formatRelinkResults(data) {
      if (!data.results || !Array.isArray(data.results)) {
        return [];
      }
      return data.results.map((item, index) => ({
        name: item.name,
        index: item.index,
        summary: item.summary,
        id: index
      }));
    },

    goHome() {
      console.log(this.$router)
      this.$router.push({ name: 'Home' });
    },

    handleFileInput(e) {
      var file = e.target.files[0];
      if (file.type !== "application/epub+zip") {
        alert("Please select an EPUB file.");
        return;
      }
    },

    highlightSelection() {
      // Ëé∑Âèñiframe‰∏≠ÁöÑÈÄâ‰∏≠ËåÉÂõ¥
      const range = this.getSelectedRangeFromIframe();
      if (range) {
        const text = range.toString();
        if (text) {
          // Âú®ÊéßÂà∂Âè∞ËæìÂá∫È´ò‰∫ÆÁöÑÊñáÊú¨
          console.log('È´ò‰∫ÆÊñáÊú¨:', text);
          
          // ÊâãÂä®ÂàõÂª∫È´ò‰∫ÆÊïàÊûú
          this.createHighlight(range);
          
          // ÈöêËóè‰∏ä‰∏ãÊñáËèúÂçï
          this.showContextMenu = false;
          
          // Ê∏ÖÈô§ÈÄâÊã©
          const selection = range.startContainer.ownerDocument.defaultView.getSelection();
          if (selection) {
            selection.removeAllRanges();
          }
        }
      }
    },

    showNoteInputDialog() {
      // Ëé∑Âèñiframe‰∏≠ÁöÑÈÄâ‰∏≠ËåÉÂõ¥
      const range = this.getSelectedRangeFromIframe();
      if (range) {
        const text = range.toString();
        if (text) {
          this.selectedText = text;
          this.currentNoteText = '';
          this.currentHighlightId = null;
          
          // ËÆæÁΩÆÁ¨îËÆ∞ËæìÂÖ•Ê°Ü‰ΩçÁΩÆÔºåÂπ∂Á°Æ‰øù‰∏çË∂ÖÂá∫Â±èÂπïËæπÁïå
          this.noteInputPosition = this.calculateNoteInputPosition(this.contextMenuPosition);
          
          // ÈöêËóè‰∏ä‰∏ãÊñáËèúÂçïÔºåÊòæÁ§∫Á¨îËÆ∞ËæìÂÖ•Ê°Ü
          this.showContextMenu = false;
          this.showNoteInput = true;
        }
      }
    },

    calculateNoteInputPosition(originalPosition) {
      // Á¨îËÆ∞ËæìÂÖ•Ê°ÜÁöÑÂ∞∫ÂØ∏
      const noteInputWidth = 350; // È¢Ñ‰º∞ÂÆΩÂ∫¶
      const noteInputHeight = 280; // È¢Ñ‰º∞È´òÂ∫¶ÔºàÂåÖÂê´Ê†áÈ¢ò„ÄÅÈÄâ‰∏≠ÊñáÊú¨„ÄÅËæìÂÖ•Ê°Ü„ÄÅÊåâÈíÆÁ≠âÔºâ
      const padding = 20; // ËæπË∑ù
      
      let x = originalPosition.x;
      let y = originalPosition.y;
      
      // Ê£ÄÊü•Âè≥ËæπÁïå
      if (x + noteInputWidth > window.innerWidth - padding) {
        x = window.innerWidth - noteInputWidth - padding;
      }
      
      // Ê£ÄÊü•Â∑¶ËæπÁïå
      if (x < padding) {
        x = padding;
      }
      
      // Ê£ÄÊü•‰∏ãËæπÁïå - Â¶ÇÊûú‰ºöË∂ÖÂá∫Â±èÂπïÂ∫ïÈÉ®ÔºåÂàôÊòæÁ§∫Âú®ÈÄâ‰∏≠ÊñáÊú¨‰∏äÊñπ
      if (y + noteInputHeight > window.innerHeight - padding) {
        y = y - noteInputHeight - 20; // Âêë‰∏äÂÅèÁßªÔºåÁïôÂá∫‰∏Ä‰∫õÈó¥Ë∑ù
      }
      
      // Ê£ÄÊü•‰∏äËæπÁïå
      if (y < padding) {
        y = padding;
      }
      
      return { x, y };
    },

    hideNoteInput() {
      this.showNoteInput = false;
      this.showContextMenu = false; // ÂêåÊó∂ÈöêËóè‰∏ä‰∏ãÊñáËèúÂçï
      this.currentNoteText = '';
      this.currentHighlightId = null;
    },

    async saveNote() {
      if (!this.currentNoteText.trim()) {
        return; // Â¶ÇÊûúÊ≤°ÊúâÁ¨îËÆ∞ÂÜÖÂÆπÔºå‰∏ç‰øùÂ≠ò
      }

      // Ëé∑Âèñiframe‰∏≠ÁöÑÈÄâ‰∏≠ËåÉÂõ¥
      const range = this.getSelectedRangeFromIframe();
      if (range) {
        const text = range.toString();
        if (text) {
          // ÂàõÂª∫È´ò‰∫ÆÂπ∂‰øùÂ≠òÁ¨îËÆ∞
          this.createHighlightWithNote(range, this.currentNoteText);
          
          // ÂèëÈÄÅÁ¨îËÆ∞Âà∞API
          await this.submitNoteToAPI(text, this.currentNoteText);
          
          // ÈöêËóèÁ¨îËÆ∞ËæìÂÖ•Ê°ÜÂíå‰∏ä‰∏ãÊñáËèúÂçï
          this.hideNoteInput();
          this.showContextMenu = false;
          
          // Ê∏ÖÈô§ÈÄâÊã©
          const selection = range.startContainer.ownerDocument.defaultView.getSelection();
          if (selection) {
            selection.removeAllRanges();
          }
        }
      }
    },

    getHighlightNote(highlightId) {
      if (!highlightId) return null;
      const highlight = this.highlights.find(h => h.id === highlightId);
      return highlight ? highlight.note : null;
    },

    createHighlight(range) {
      try {
        // ÂàõÂª∫È´ò‰∫ÆÂÖÉÁ¥†
        const highlight = document.createElement('span');
        highlight.className = 'epub-highlight';
        highlight.style.backgroundColor = '#fef08a';
        highlight.style.color = '#000';
        
        // ÁîüÊàêÂîØ‰∏ÄID
        const highlightId = this.generateHighlightId();
        highlight.setAttribute('data-highlight-id', highlightId);
        
        // Â∞ÜÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÂåÖË£ÖÂú®È´ò‰∫ÆÂÖÉÁ¥†‰∏≠
        range.surroundContents(highlight);
        
        // ‰øùÂ≠òÈ´ò‰∫Æ‰ø°ÊÅØ
        this.saveHighlight(range, highlightId);
        
        // ÂèëÈÄÅÈ´ò‰∫ÆÂà∞APIÔºàcomment‰∏∫Á©∫Ôºâ
        const text = range.toString();
        if (text) {
          this.submitNoteToAPI(text, '');
        }
        
        console.log('È´ò‰∫ÆÂàõÂª∫ÊàêÂäüÔºåID:', highlightId);
      } catch (error) {
        console.error('ÂàõÂª∫È´ò‰∫ÆÂ§±Ë¥•:', error);
        
        // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰øÆÊîπÊ†∑Âºè
        try {
          const selection = range.startContainer.ownerDocument.defaultView.getSelection();
          if (selection.rangeCount > 0) {
            const range2 = selection.getRangeAt(0);
            const contents = range2.extractContents();
            const highlight = document.createElement('span');
            highlight.className = 'epub-highlight';
            highlight.style.backgroundColor = '#fef08a';
            highlight.style.color = '#000';
            
            const highlightId = this.generateHighlightId();
            highlight.setAttribute('data-highlight-id', highlightId);
            highlight.appendChild(contents);
            highlight.appendChild(contents);
            range2.insertNode(highlight);
            
            // ‰øùÂ≠òÈ´ò‰∫Æ‰ø°ÊÅØ
            this.saveHighlight(range2, highlightId);
            
            // ÂèëÈÄÅÈ´ò‰∫ÆÂà∞APIÔºàcomment‰∏∫Á©∫Ôºâ
            const text = range2.toString();
            if (text) {
              this.submitNoteToAPI(text, '');
            }
            
            console.log('Â§áÁî®È´ò‰∫ÆÊñπÊ≥ïÊàêÂäüÔºåID:', highlightId);
          }
        } catch (error2) {
          console.error('Â§áÁî®È´ò‰∫ÆÊñπÊ≥ï‰πüÂ§±Ë¥•:', error2);
        }
      }
    },

    createHighlightWithNote(range, noteText) {
      try {
        // ÂàõÂª∫È´ò‰∫ÆÂÖÉÁ¥†
        const highlight = document.createElement('span');
        highlight.className = 'epub-highlight';
        highlight.style.backgroundColor = '#fef08a';
        highlight.style.color = '#000';
        
        // ÁîüÊàêÂîØ‰∏ÄID
        const highlightId = this.generateHighlightId();
        highlight.setAttribute('data-highlight-id', highlightId);
        
        // Â∞ÜÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÂåÖË£ÖÂú®È´ò‰∫ÆÂÖÉÁ¥†‰∏≠
        range.surroundContents(highlight);
        
        // ‰øùÂ≠òÈ´ò‰∫Æ‰ø°ÊÅØÔºàÂåÖÂê´Á¨îËÆ∞Ôºâ
        this.saveHighlight(range, highlightId, noteText);
        
        console.log('Â∏¶Á¨îËÆ∞ÁöÑÈ´ò‰∫ÆÂàõÂª∫ÊàêÂäüÔºåID:', highlightId);
      } catch (error) {
        console.error('ÂàõÂª∫Â∏¶Á¨îËÆ∞ÁöÑÈ´ò‰∫ÆÂ§±Ë¥•:', error);
        
        // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•‰øÆÊîπÊ†∑Âºè
        try {
          const selection = range.startContainer.ownerDocument.defaultView.getSelection();
          if (selection.rangeCount > 0) {
            const range2 = selection.getRangeAt(0);
            const contents = range2.extractContents();
            const highlight = document.createElement('span');
            highlight.className = 'epub-highlight';
            highlight.style.backgroundColor = '#fef08a';
            highlight.style.color = '#000';
            
            const highlightId = this.generateHighlightId();
            highlight.setAttribute('data-highlight-id', highlightId);
            highlight.appendChild(contents);
            range2.insertNode(highlight);
            
            // ‰øùÂ≠òÈ´ò‰∫Æ‰ø°ÊÅØÔºàÂåÖÂê´Á¨îËÆ∞Ôºâ
            this.saveHighlight(range2, highlightId, noteText);
            
            console.log('Â§áÁî®Â∏¶Á¨îËÆ∞È´ò‰∫ÆÊñπÊ≥ïÊàêÂäüÔºåID:', highlightId);
          }
        } catch (error2) {
          console.error('Â§áÁî®Â∏¶Á¨îËÆ∞È´ò‰∫ÆÊñπÊ≥ï‰πüÂ§±Ë¥•:', error2);
        }
      }
    },

    generateHighlightId() {
      return 'highlight_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    },

    saveHighlight(range, highlightId, noteText = null) {
      try {
        // Ëé∑ÂèñÈ´ò‰∫Æ‰ø°ÊÅØ
        const highlightInfo = {
          id: highlightId,
          text: range.toString(),
          cfi: this.getCFIFromRange(range), // epubjsÁöÑCFIÂÆö‰Ωç
          timestamp: Date.now(),
          bookId: this.fileName,
          note: noteText // Ê∑ªÂä†Á¨îËÆ∞Â≠óÊÆµ
        };
        
        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        this.saveHighlightToStorage(highlightInfo);
        
        // Ê∑ªÂä†Âà∞ÂΩìÂâçÈ´ò‰∫ÆÂàóË°®
        this.highlights.push(highlightInfo);
        
        console.log('È´ò‰∫Æ‰ø°ÊÅØÂ∑≤‰øùÂ≠ò:', highlightInfo);
      } catch (error) {
        console.error('‰øùÂ≠òÈ´ò‰∫Æ‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    },

    getCFIFromRange() {
      try {
        // Â∞ùËØï‰ΩøÁî®epubjsÁöÑCFIÂäüËÉΩ
        if (this.rendition && this.rendition.location) {
          const location = this.rendition.location;
          return location.start.cfi;
        }
        return null;
      } catch (error) {
        console.error('Ëé∑ÂèñCFIÂ§±Ë¥•:', error);
        return null;
      }
    },

    saveHighlightToStorage(highlightInfo) {
      try {
        const key = `highlights_${this.fileName}`;
        let highlights = JSON.parse(localStorage.getItem(key) || '[]');
        highlights.push(highlightInfo);
        localStorage.setItem(key, JSON.stringify(highlights));
      } catch (error) {
        console.error('‰øùÂ≠òÂà∞localStorageÂ§±Ë¥•:', error);
      }
    },

    loadHighlights() {
      try {
        const key = `highlights_${this.fileName}`;
        const highlights = JSON.parse(localStorage.getItem(key) || '[]');
        this.highlights = highlights;
        console.log('Âä†ËΩΩÈ´ò‰∫Æ‰ø°ÊÅØ:', highlights);
        return highlights;
      } catch (error) {
        console.error('Âä†ËΩΩÈ´ò‰∫Æ‰ø°ÊÅØÂ§±Ë¥•:', error);
        return [];
      }
    },

    restoreHighlights() {
      const highlights = this.loadHighlights();
      if (highlights.length > 0) {
        // Á≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂÆåÊàêÂêéÊÅ¢Â§çÈ´ò‰∫Æ
        setTimeout(() => {
          this.restoreHighlightsForCurrentPage();
        }, 1000);
      }
    },

    restoreHighlightsForCurrentPage() {
      // Èò≤Ê≠¢ÈáçÂ§çÊÅ¢Â§ç
      if (this.isRestoringHighlights) {
        console.log('Ê≠£Âú®ÊÅ¢Â§çÈ´ò‰∫Æ‰∏≠ÔºåË∑≥ËøáÈáçÂ§çË∞ÉÁî®');
        return;
      }
      
      const highlights = this.loadHighlights();
      if (highlights.length === 0) return;
      
      // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÁöÑCFI
      const currentCFI = this.rendition?.location?.start?.cfi;
      if (!currentCFI) return;
      
      // ËÆæÁΩÆÊÅ¢Â§çÊ†áÂøó
      this.isRestoringHighlights = true;
      
      // ËøáÊª§Âá∫ÂΩìÂâçÈ°µÈù¢ÁöÑÈ´ò‰∫Æ
      const currentPageHighlights = highlights.filter(highlight => {
        // Â¶ÇÊûúÈ´ò‰∫ÆÊúâCFI‰ø°ÊÅØÔºåÊ£ÄÊü•ÊòØÂê¶Âú®ÂΩìÂâçÈ°µÈù¢
        if (highlight.cfi) {
          return this.isCFIInCurrentPage(highlight.cfi, currentCFI);
        }
        // Â¶ÇÊûúÊ≤°ÊúâCFI‰ø°ÊÅØÔºåÂ∞ùËØïÂú®ÂΩìÂâçÈ°µÈù¢Êü•ÊâæÊñáÊú¨
        return true;
      });
      
      if (currentPageHighlights.length > 0) {
        console.log('ÊÅ¢Â§çÂΩìÂâçÈ°µÈù¢È´ò‰∫ÆÔºåÊï∞Èáè:', currentPageHighlights.length);
      }
      
      // ÊÅ¢Â§çÂΩìÂâçÈ°µÈù¢ÁöÑÈ´ò‰∫ÆÔºà‰∏çÊîπÂèòÈ°µÈù¢‰ΩçÁΩÆÔºâ
      currentPageHighlights.forEach(highlight => {
        this.restoreHighlightWithoutNavigation(highlight);
      });
      
      // Âª∂ËøüÈáçÁΩÆÊ†áÂøó
      setTimeout(() => {
        this.isRestoringHighlights = false;
      }, 500);
    },

    isCFIInCurrentPage(highlightCFI, currentCFI) {
      try {
        // ÁÆÄÂçïÁöÑCFIÊØîËæÉÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏ÄÁ´†ËäÇ
        const highlightChapter = highlightCFI.split('/')[1];
        const currentChapter = currentCFI.split('/')[1];
        return highlightChapter === currentChapter;
      } catch (error) {
        console.error('CFIÊØîËæÉÂ§±Ë¥•:', error);
        return false;
      }
    },

    restoreHighlight(highlightInfo) {
      try {
        // ‰ΩøÁî®CFIÂÆö‰ΩçÂà∞È´ò‰∫Æ‰ΩçÁΩÆ
        if (highlightInfo.cfi && this.rendition) {
          this.rendition.display(highlightInfo.cfi).then(() => {
            // Âú®ÂÜÖÂÆπ‰∏≠Êü•ÊâæÂπ∂È´ò‰∫ÆÊñáÊú¨
            this.findAndHighlightText(highlightInfo);
          });
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâCFIÔºåÁõ¥Êé•Êü•ÊâæÊñáÊú¨
          this.findAndHighlightText(highlightInfo);
        }
      } catch (error) {
        console.error('ÊÅ¢Â§çÈ´ò‰∫ÆÂ§±Ë¥•:', error);
      }
    },

    restoreHighlightWithoutNavigation(highlightInfo) {
      try {
        // Áõ¥Êé•Âú®ÂΩìÂâçÈ°µÈù¢Êü•ÊâæÂπ∂È´ò‰∫ÆÊñáÊú¨Ôºå‰∏çÊîπÂèòÈ°µÈù¢‰ΩçÁΩÆ
        this.findAndHighlightText(highlightInfo);
      } catch (error) {
        console.error('ÊÅ¢Â§çÈ´ò‰∫ÆÂ§±Ë¥•:', error);
      }
    },

    findAndHighlightText(highlightInfo) {
      try {
        console.log('ÂºÄÂßãÊü•ÊâæÈ´ò‰∫ÆÊñáÊú¨:', highlightInfo.text);
        const viewer = document.getElementById('viewer');
        const iframes = viewer.getElementsByTagName('iframe');
        console.log('ÊâæÂà∞iframeÊï∞Èáè:', iframes.length);
        
        for (let iframe of iframes) {
          try {
            const frameDocument = iframe.contentDocument;
            if (frameDocument) {
              // console.log('Ê£ÄÊü•iframe:', iframe);
              
              // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®Ëøô‰∏™È´ò‰∫Æ
              const existingHighlight = frameDocument.querySelector(`[data-highlight-id="${highlightInfo.id}"]`);
              if (existingHighlight) {
                console.log('È´ò‰∫ÆÂ∑≤Â≠òÂú®ÔºåË∑≥Ëøá:', highlightInfo.text);
                return;
              }
              
              // Êü•ÊâæÂåÖÂê´È´ò‰∫ÆÊñáÊú¨ÁöÑÂÖÉÁ¥†ÔºàÂåÖÊã¨ÊªöÂä®ÂÜÖÂÆπÔºâ
              const allTextNodes = [];
              const walker = document.createTreeWalker(
                frameDocument.body,
                NodeFilter.SHOW_TEXT,
                null,
                false
              );
              
              let node;
              while ((node = walker.nextNode())) {
                allTextNodes.push(node);
              }
              
              console.log('ÊâæÂà∞ÊñáÊú¨ËäÇÁÇπÊï∞Èáè:', allTextNodes.length);
              
              // Âú®ÊâÄÊúâÊñáÊú¨ËäÇÁÇπ‰∏≠Êü•ÊâæÈ´ò‰∫ÆÊñáÊú¨
              for (let textNode of allTextNodes) {
                if (textNode.textContent.includes(highlightInfo.text)) {
                  console.log('ÊâæÂà∞ÂåπÈÖçÁöÑÊñáÊú¨ËäÇÁÇπ:', textNode.textContent.substring(0, 50) + '...');
                  
                  // Ê£ÄÊü•Ëøô‰∏™ÊñáÊú¨ËäÇÁÇπÊòØÂê¶Â∑≤ÁªèË¢´È´ò‰∫Æ
                  const parent = textNode.parentNode;
                  if (parent && parent.classList && parent.classList.contains('epub-highlight')) {
                    console.log('ÊñáÊú¨Â∑≤Ë¢´È´ò‰∫ÆÔºåË∑≥Ëøá');
                    continue; // Ë∑≥ËøáÂ∑≤ÁªèË¢´È´ò‰∫ÆÁöÑÊñáÊú¨
                  }
                  
                  // ÊâæÂà∞ÊñáÊú¨ÔºåÂàõÂª∫È´ò‰∫Æ
                  const range = document.createRange();
                  const startIndex = textNode.textContent.indexOf(highlightInfo.text);
                  range.setStart(textNode, startIndex);
                  range.setEnd(textNode, startIndex + highlightInfo.text.length);
                  
                                      const highlight = document.createElement('span');
                    highlight.className = 'epub-highlight';
                    highlight.style.backgroundColor = '#fef08a';
                    highlight.style.color = '#000';
                    highlight.setAttribute('data-highlight-id', highlightInfo.id);
                    
                    // Â¶ÇÊûúÊúâÁ¨îËÆ∞ÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                    if (highlightInfo.note) {
                      highlight.style.borderBottom = '2px solid #3b82f6';
                      highlight.style.borderBottomStyle = 'dotted';
                    }
                  
                  // Â¶ÇÊûúÊúâÁ¨îËÆ∞ÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
                  if (highlightInfo.note) {
                    highlight.style.borderBottom = '2px solid #3b82f6';
                    highlight.style.borderBottomStyle = 'dotted';
                  }
                  
                  try {
                    range.surroundContents(highlight);
                    console.log('È´ò‰∫ÆÂ∑≤ÊÅ¢Â§ç:', highlightInfo.text);
                    
                    // ‰∏∫Êñ∞ÂàõÂª∫ÁöÑÈ´ò‰∫ÆÂÖÉÁ¥†Ê∑ªÂä†ÊÇ¨ÂÅú‰∫ã‰ª∂
                    this.addHoverEventToHighlight(highlight);
                    
                    break;
                  } catch (error) {
                    console.log('È´ò‰∫ÆÂàõÂª∫Â§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®ÊñπÊ≥ï:', error);
                    // Â§áÁî®ÊñπÊ≥ïÔºöÁõ¥Êé•ÊèíÂÖ•È´ò‰∫ÆÂÖÉÁ¥†
                    try {
                      const contents = range.extractContents();
                      highlight.appendChild(contents);
                      range.insertNode(highlight);
                      console.log('Â§áÁî®ÊñπÊ≥ïÈ´ò‰∫ÆÂ∑≤ÊÅ¢Â§ç:', highlightInfo.text);
                      
                      // ‰∏∫Êñ∞ÂàõÂª∫ÁöÑÈ´ò‰∫ÆÂÖÉÁ¥†Ê∑ªÂä†ÊÇ¨ÂÅú‰∫ã‰ª∂
                      this.addHoverEventToHighlight(highlight);
                      
                      break;
                    } catch (error2) {
                      console.log('Â§áÁî®ÊñπÊ≥ï‰πüÂ§±Ë¥•:', error2);
                      continue;
                    }
                  }
                }
              }
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframe:', e);
          }
        }
      } catch (error) {
        console.error('Êü•ÊâæÂπ∂È´ò‰∫ÆÊñáÊú¨Â§±Ë¥•:', error);
      }
    },

    removeHighlight(highlightId) {
      try {
        // ‰ªéDOM‰∏≠ÁßªÈô§È´ò‰∫ÆÂÖÉÁ¥†
        const viewer = document.getElementById('viewer');
        const iframes = viewer.getElementsByTagName('iframe');
        
        for (let iframe of iframes) {
          try {
            const frameDocument = iframe.contentDocument;
            if (frameDocument) {
              const highlightElement = frameDocument.querySelector(`[data-highlight-id="${highlightId}"]`);
              if (highlightElement) {
                // Â∞ÜÈ´ò‰∫ÆÂÖÉÁ¥†ÁöÑÂÜÖÂÆπÊõøÊç¢‰∏∫Á∫ØÊñáÊú¨
                const parent = highlightElement.parentNode;
                const textContent = highlightElement.textContent;
                const textNode = document.createTextNode(textContent);
                parent.replaceChild(textNode, highlightElement);
                console.log('È´ò‰∫ÆÂ∑≤ÁßªÈô§:', highlightId);
                break;
              }
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframe:', e);
          }
        }
        
        // ‰ªéÂ≠òÂÇ®‰∏≠ÁßªÈô§È´ò‰∫Æ‰ø°ÊÅØ
        this.removeHighlightFromStorage(highlightId);
        
        // ‰ªéÂΩìÂâçÂàóË°®‰∏≠ÁßªÈô§
        this.highlights = this.highlights.filter(h => h.id !== highlightId);
        
      } catch (error) {
        console.error('ÁßªÈô§È´ò‰∫ÆÂ§±Ë¥•:', error);
      }
    },

    removeHighlightFromStorage(highlightId) {
      try {
        const key = `highlights_${this.fileName}`;
        let highlights = JSON.parse(localStorage.getItem(key) || '[]');
        highlights = highlights.filter(h => h.id !== highlightId);
        localStorage.setItem(key, JSON.stringify(highlights));
        console.log('È´ò‰∫Æ‰ø°ÊÅØÂ∑≤‰ªéÂ≠òÂÇ®‰∏≠ÁßªÈô§:', highlightId);
      } catch (error) {
        console.error('‰ªéÂ≠òÂÇ®‰∏≠ÁßªÈô§È´ò‰∫ÆÂ§±Ë¥•:', error);
      }
    },

    clearAllHighlights() {
      try {
        // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÂÖÉÁ¥†
        const viewer = document.getElementById('viewer');
        const iframes = viewer.getElementsByTagName('iframe');
        
        for (let iframe of iframes) {
          try {
            const frameDocument = iframe.contentDocument;
            if (frameDocument) {
              const highlightElements = frameDocument.querySelectorAll('.epub-highlight');
              highlightElements.forEach(element => {
                const parent = element.parentNode;
                const textContent = element.textContent;
                const textNode = document.createTextNode(textContent);
                parent.replaceChild(textNode, element);
              });
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframe:', e);
          }
        }
        
        // Ê∏ÖÈô§Â≠òÂÇ®
        const key = `highlights_${this.fileName}`;
        localStorage.removeItem(key);
        
        // Ê∏ÖÁ©∫ÂΩìÂâçÂàóË°®
        this.highlights = [];
        
        console.log('ÊâÄÊúâÈ´ò‰∫ÆÂ∑≤Ê∏ÖÈô§');
      } catch (error) {
        console.error('Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÂ§±Ë¥•:', error);
      }
    },

    addHighlightHoverEvents(doc) {
      // ‰∏∫Áé∞ÊúâÁöÑÈ´ò‰∫ÆÂÖÉÁ¥†Ê∑ªÂä†ÊÇ¨ÂÅú‰∫ã‰ª∂
      const highlightElements = doc.querySelectorAll('.epub-highlight');
      highlightElements.forEach(element => {
        this.addHoverEventToHighlight(element);
      });
      
      // ÁõëÂê¨Êñ∞Ê∑ªÂä†ÁöÑÈ´ò‰∫ÆÂÖÉÁ¥†
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              if (node.classList && node.classList.contains('epub-highlight')) {
                this.addHoverEventToHighlight(node);
              }
              // Ê£ÄÊü•Â≠êÂÖÉÁ¥†
              const childHighlights = node.querySelectorAll('.epub-highlight');
              childHighlights.forEach(element => {
                this.addHoverEventToHighlight(element);
              });
            }
          });
        });
      });
      
      observer.observe(doc.body, {
        childList: true,
        subtree: true
      });
    },

    addHoverEventToHighlight(element) {
      // ÁßªÈô§Áé∞ÊúâÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈÅøÂÖçÈáçÂ§çÔºâ
      element.removeEventListener('mouseenter', this.handleHighlightHover);
      element.removeEventListener('mouseleave', this.handleHighlightLeave);
      
      // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
      element.addEventListener('mouseenter', this.handleHighlightHover);
      element.addEventListener('mouseleave', this.handleHighlightLeave);
    },

    handleHighlightHover(event) {
      const highlightElement = event.target;
      const highlightId = highlightElement.getAttribute('data-highlight-id');
      
      if (highlightId) {
        this.isHoveringHighlight = true;
        this.hoveredHighlightId = highlightId;
        
        // Ëé∑ÂèñÊ≠£Á°ÆÁöÑËèúÂçï‰ΩçÁΩÆÔºåËÄÉËôëiframeÁöÑÂÅèÁßª
        const viewer = document.getElementById('viewer');
        const iframes = viewer.getElementsByTagName('iframe');
        let menuX = 0;
        let menuY = 0;
        
        // Êü•ÊâæÂåÖÂê´È´ò‰∫ÆÂÖÉÁ¥†ÁöÑiframe
        for (let iframe of iframes) {
          try {
            const frameDocument = iframe.contentDocument;
            if (frameDocument && frameDocument.contains(highlightElement)) {
              // Ëé∑ÂèñiframeÁöÑ‰ΩçÁΩÆ
              const iframeRect = iframe.getBoundingClientRect();
              // Ëé∑ÂèñÈ´ò‰∫ÆÂÖÉÁ¥†Âú®iframeÂÜÖÁöÑ‰ΩçÁΩÆ
              const highlightRect = highlightElement.getBoundingClientRect();
              
              // ËÆ°ÁÆóÁõ∏ÂØπ‰∫éÈ°µÈù¢ÁöÑ‰ΩçÁΩÆ
              menuX = iframeRect.left + highlightRect.left + (highlightRect.width / 2);
              menuY = iframeRect.top + highlightRect.top - 10;
              break;
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframe:', e);
          }
        }
        
        // Á°Æ‰øùËèúÂçïÂú®ÂèØËßÜÂå∫ÂüüÂÜÖ
        const menuWidth = 120;
        const menuHeight = 80;
        const padding = 10;
        
        if (menuX + menuWidth > window.innerWidth) {
          menuX = window.innerWidth - menuWidth - padding;
        }
        
        if (menuY + menuHeight > window.innerHeight) {
          menuY = menuY - menuHeight - padding;
        }
        
        if (menuX < padding) {
          menuX = padding;
        }
        
        if (menuY < padding) {
          menuY = padding;
        }
        
        this.contextMenuPosition = { x: menuX, y: menuY };
        console.log("contextMenuPosition", this.contextMenuPosition);
        this.showContextMenu = true;
      }
    },

    handleHighlightLeave() {
      setTimeout(() => {
        if (!this.contextMenuHovering && !this.noteInputHovering) {
          this.isHoveringHighlight = false;
          this.hoveredHighlightId = null;
          this.showContextMenu = false;
          this.showNoteInput = false;
        }
      }, 200);
    },

    handleContextMenuLeave() {
      this.contextMenuHovering = false;
      setTimeout(() => {
        if (!this.isHoveringHighlight && !this.contextMenuHovering && !this.noteInputHovering) {
          this.showContextMenu = false;
        }
      }, 200);
    },

    handleNoteInputLeave() {
      this.noteInputHovering = false;
      setTimeout(() => {
        if (!this.isHoveringHighlight && !this.contextMenuHovering && !this.noteInputHovering) {
          this.showNoteInput = false;
        }
      }, 200);
    },

    getSelectedRangeFromIframe() {
      const viewer = document.getElementById('viewer');
      if (!viewer) return null;
      
      // Êü•ÊâæviewerÂÜÖÁöÑiframe
      const iframes = viewer.getElementsByTagName('iframe');
      
      for (let iframe of iframes) {
        try {
          const frameWindow = iframe.contentWindow;
          const frameDocument = frameWindow && frameWindow.document;
          
          if (frameDocument && frameDocument.getSelection) {
            const selection = frameDocument.getSelection();
            if (selection.rangeCount > 0) {
              return selection.getRangeAt(0);
            }
          }
        } catch (e) {
          console.log('Êó†Ê≥ïËÆøÈóÆiframeÂÜÖÂÆπ:', e);
        }
      }
      
      return null;
    },

    handleTextSelection(event) {
      console.log("handleTextSelection", event)
      
      // Âè™Â§ÑÁêÜÂ∑¶ÈîÆÁÇπÂáª (button === 0)
      if (event.button !== 0) {
        console.log("ÈùûÂ∑¶ÈîÆÁÇπÂáªÔºåÂøΩÁï•");
        return;
      }
      
      setTimeout(() => {
        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊñáÊú¨ÔºåÊîØÊåÅiframe
        const selectedText = this.getSelectedTextFromIframe();
        console.log("selectedText", selectedText)
        
        if (!selectedText) {
          this.showContextMenu = false;
          return;
        }
        
        this.selectedText = selectedText;
        
        // Ëé∑ÂèñÊ≠£Á°ÆÁöÑÈº†Ê†á‰ΩçÁΩÆÔºåËÄÉËôëiframeÁöÑÊªöÂä®‰ΩçÁΩÆ
        const viewer = document.getElementById('viewer');
        const iframes = viewer.getElementsByTagName('iframe');
        let mouseX = event.clientX;
        let mouseY = event.clientY;
        
        // Â¶ÇÊûú‰∫ã‰ª∂Êù•Ëá™iframeÔºåÈúÄË¶ÅË∞ÉÊï¥‰ΩçÁΩÆ
        for (let iframe of iframes) {
          try {
            const frameWindow = iframe.contentWindow;
            if (frameWindow && frameWindow.document === event.target.ownerDocument) {
              // ‰∫ã‰ª∂Êù•Ëá™Ëøô‰∏™iframeÔºåÈúÄË¶ÅË∞ÉÊï¥‰ΩçÁΩÆ
              const iframeRect = iframe.getBoundingClientRect();
              
              // ‰ΩøÁî®iframeÂÜÖÁöÑÈº†Ê†á‰ΩçÁΩÆ
              mouseX = iframeRect.left + event.clientX;
              mouseY = iframeRect.top + event.clientY;
              break;
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframe:', e);
          }
        }
        
        // ËÆ°ÁÆó‰∏ä‰∏ãÊñáËèúÂçï‰ΩçÁΩÆÔºåÁ°Æ‰øùÂú®ÂèØËßÜÂå∫ÂüüÂÜÖ
        const menuWidth = 120; // ËèúÂçïÂÆΩÂ∫¶
        const menuHeight = 80; // ËèúÂçïÈ´òÂ∫¶
        const padding = 10;
        
        let x = mouseX;
        let y = mouseY + 10;
        
        // Á°Æ‰øùËèúÂçï‰∏çË∂ÖÂá∫Âè≥ËæπÁïå
        if (x + menuWidth > window.innerWidth) {
          x = window.innerWidth - menuWidth - padding;
        }
        
        // Á°Æ‰øùËèúÂçï‰∏çË∂ÖÂá∫‰∏ãËæπÁïå
        if (y + menuHeight > window.innerHeight) {
          y = mouseY - menuHeight - padding;
        }
        
        // Á°Æ‰øùËèúÂçï‰∏çË∂ÖÂá∫Â∑¶ËæπÁïå
        if (x < padding) {
          x = padding;
        }
        
        // Á°Æ‰øùËèúÂçï‰∏çË∂ÖÂá∫‰∏äËæπÁïå
        if (y < padding) {
          y = padding;
        }
        
        this.contextMenuPosition = { x, y };
        
        this.showContextMenu = true;
        console.log('showContextMenuËÆæÁΩÆ‰∏∫trueÔºå‰ΩçÁΩÆ:', this.contextMenuPosition);
        console.log('Á™óÂè£Â∞∫ÂØ∏:', window.innerWidth, 'x', window.innerHeight);
        console.log('ÂéüÂßã‰∫ã‰ª∂‰ΩçÁΩÆ:', event.clientX, event.clientY);
        console.log('Ë∞ÉÊï¥Âêé‰ΩçÁΩÆ:', mouseX, mouseY);
      }, 50);
    },

    getSelectedTextFromIframe() {
      const viewer = document.getElementById('viewer');
      if (!viewer) return '';
      
      // Êü•ÊâæviewerÂÜÖÁöÑiframe
      const iframes = viewer.getElementsByTagName('iframe');
      
      for (let iframe of iframes) {
        try {
          const frameWindow = iframe.contentWindow;
          const frameDocument = frameWindow && frameWindow.document;
          
          if (frameDocument) {
            if (frameDocument.getSelection) {
              // Â§ßÂ§öÊï∞ÊµèËßàÂô®
              const selection = frameDocument.getSelection();
              const text = String(selection);
              if (text && text.trim()) {
                return text.trim();
              }
            } else if (frameDocument.selection) {
              // Internet Explorer 8 Âèä‰ª•‰∏ã
              const text = frameDocument.selection.createRange().text;
              if (text && text.trim()) {
                return text.trim();
              }
            } else if (frameWindow.getSelection) {
              // Safari 3
              const selection = frameWindow.getSelection();
              const text = String(selection);
              if (text && text.trim()) {
                return text.trim();
              }
            }
          }
        } catch (e) {
          console.log('Êó†Ê≥ïËÆøÈóÆiframeÂÜÖÂÆπ:', e);
        }
      }
      
      // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞iframeÔºåÂ∞ùËØï‰ªé‰∏ªÊñáÊ°£Ëé∑Âèñ
      const selection = window.getSelection();
      const text = String(selection);
      return text ? text.trim() : '';
    },

    hideContextMenu(event) {
      console.log('hideContextMenuË¢´Ë∞ÉÁî®', event);
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰∏ä‰∏ãÊñáËèúÂçïÊú¨Ë∫´Ôºå‰∏çÈöêËóè
      if (event && event.target && event.target.closest('.context-menu')) {
        console.log('ÁÇπÂáªÁöÑÊòØ‰∏ä‰∏ãÊñáËèúÂçïÊú¨Ë∫´Ôºå‰∏çÈöêËóè');
        return;
      }
      this.showContextMenu = false;
      this.isHoveringHighlight = false;
      this.hoveredHighlightId = null;
      console.log('showContextMenuËÆæÁΩÆ‰∏∫false');
    },

    handleResize() {
      this.isResizing = true;
      if (this.resizeTimeout) {
        clearTimeout(this.resizeTimeout);
      }
      this.resizeTimeout = setTimeout(() => {
        this.isResizing = false;
      }, 100);
    },

    // ÈòÖËØªËøõÂ∫¶Ë∑üË∏™ÊñπÊ≥ï
    checkReadingProgress() {
      const readingKey = `reading-progress-${this.fileName}`;
      const lastReading = localStorage.getItem(readingKey);
      
      if (lastReading) {
        try {
          const lastReadingData = JSON.parse(lastReading);
          const now = new Date();
          const lastTime = new Date(lastReadingData.timestamp);
          const timeDiff = now - lastTime;
          
          // Â¶ÇÊûúË∑ùÁ¶ª‰∏äÊ¨°ÈòÖËØªË∂ÖËøá1Â∞èÊó∂ÔºåÊòæÁ§∫ÊèêÈÜí
          if (timeDiff >  1000) {
            this.lastReadingInfo = {
              timestamp: lastReadingData.timestamp,
              content: lastReadingData.content,
              progress: lastReadingData.progress,
              duration: lastReadingData.duration
            };
            console.log("lastReadingInfo", this.lastReadingInfo)
            this.showReadingProgressModal = true;
          }
        } catch (error) {
          console.error('Ëß£ÊûêÈòÖËØªËøõÂ∫¶Êï∞ÊçÆÂ§±Ë¥•:', error);
        }
      }
    },

    saveReadingProgress() {
      if (!this.rendition) return;
      
      try {
        const currentLocation = this.rendition.currentLocation();
        if (!currentLocation || !currentLocation.start) return;
        
        // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÂÜÖÂÆπ
        const currentContent = this.getCurrentPageContent();
        
        // ËÆ°ÁÆóÈòÖËØªËøõÂ∫¶ÔºàÂü∫‰∫éCFI‰ΩçÁΩÆÔºâ
        const progress = this.calculateReadingProgress();
        
        // ËÆ°ÁÆóÈòÖËØªÊó∂ÈïøÔºàËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂèØ‰ª•Êõ¥Á≤æÁ°ÆÔºâ
        const duration = this.calculateReadingDuration();
        
        const readingData = {
          timestamp: new Date().toISOString(),
          cfi: currentLocation.start.cfi,
          content: currentContent,
          progress: progress,
          duration: duration
        };
        
        const readingKey = `reading-progress-${this.fileName}`;
        localStorage.setItem(readingKey, JSON.stringify(readingData));
        
        // Ëß¶ÂèëËøõÂ∫¶Êõ¥Êñ∞‰∫ã‰ª∂
        window.dispatchEvent(new CustomEvent('reading-progress-updated', {
          detail: { fileName: this.fileName }
        }));
        
      } catch (error) {
        console.error('‰øùÂ≠òÈòÖËØªËøõÂ∫¶Â§±Ë¥•:', error);
      }
    },

    getCurrentPageContent() {
      try {
        const viewer = document.getElementById('viewer');
        if (!viewer) return '';
        
        const iframes = viewer.getElementsByTagName('iframe');
        for (let iframe of iframes) {
          try {
            const frameDocument = iframe.contentDocument || iframe.contentWindow.document;
            if (frameDocument) {
              const textContent = frameDocument.body.textContent || '';
              // ËøîÂõûÂâç100‰∏™Â≠óÁ¨¶
              return textContent.substring(0, 100).trim() + (textContent.length > 100 ? '...' : '');
            }
          } catch (e) {
            console.log('Êó†Ê≥ïËÆøÈóÆiframeÂÜÖÂÆπ:', e);
          }
        }
        return '';
      } catch (error) {
        console.error('Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÂÜÖÂÆπÂ§±Ë¥•:', error);
        return '';
      }
    },

    calculateReadingProgress() {
      try {
        if (!this.book || !this.rendition) return 0;
        
        const currentLocation = this.rendition.currentLocation();
        if (!currentLocation || !currentLocation.start) return 0;
        
        // Ëé∑ÂèñÊÄªÁ´†ËäÇÊï∞
        const totalChapters = this.book.spine.length;
        const currentChapter = currentLocation.start.index;
        
        // ÁÆÄÂåñÁöÑËøõÂ∫¶ËÆ°ÁÆóÔºàÂü∫‰∫éÁ´†ËäÇÔºâ
        return Math.round((currentChapter / totalChapters) * 100);
      } catch (error) {
        console.error('ËÆ°ÁÆóÈòÖËØªËøõÂ∫¶Â§±Ë¥•:', error);
        return 0;
      }
    },

    calculateReadingDuration() {
      // ÁÆÄÂåñÁöÑÈòÖËØªÊó∂ÈïøËÆ°ÁÆóÔºàËøôÈáåËøîÂõûÂõ∫ÂÆöÂÄºÔºåÂÆûÈôÖÂèØ‰ª•Âü∫‰∫éÊó∂Èó¥Â∑ÆËÆ°ÁÆóÔºâ
      return 15; // ÂÅáËÆæ‰∏äÊ¨°ÈòÖËØª‰∫Ü15ÂàÜÈíü
    },

    formatLastReadingTime() {
      if (!this.lastReadingInfo?.timestamp) return 'Êú™Áü•Êó∂Èó¥';
      
      try {
        const lastTime = new Date(this.lastReadingInfo.timestamp);
        const now = new Date();
        const diff = now - lastTime;
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
          return `${days}Â§©Ââç`;
        } else if (hours > 0) {
          return `${hours}Â∞èÊó∂Ââç`;
        } else if (minutes > 0) {
          return `${minutes}ÂàÜÈíüÂâç`;
        } else {
          return 'ÂàöÂàö';
        }
      } catch (error) {
        return 'Êú™Áü•Êó∂Èó¥';
      }
    },

    closeReadingProgressModal() {
      this.showReadingProgressModal = false;
    },

    continueReading() {
      this.closeReadingProgressModal();
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Ë∑≥ËΩ¨Âà∞‰∏äÊ¨°ÈòÖËØª‰ΩçÁΩÆÁöÑÈÄªËæë
    },

    // ‰øùÂ≠òÁ´†ËäÇÊëòË¶ÅÂà∞Êú¨Âú∞Â≠òÂÇ®
    saveChapterSummary(chapterId, summaryText) {
      try {
        const summaryKey = `summary_${this.fileName}_${chapterId}`;
        const summaryData = {
          text: summaryText,
          timestamp: new Date().toISOString(),
          bookId: this.fileName,
          chapterId: chapterId
        };
        localStorage.setItem(summaryKey, JSON.stringify(summaryData));
        console.log('Á´†ËäÇÊëòË¶ÅÂ∑≤‰øùÂ≠ò:', chapterId);
      } catch (error) {
        console.error('‰øùÂ≠òÁ´†ËäÇÊëòË¶ÅÂ§±Ë¥•:', error);
      }
    },

    // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁ´†ËäÇÊëòË¶Å
    loadChapterSummary(chapterId) {
      try {
        const summaryKey = `summary_${this.fileName}_${chapterId}`;
        const summaryData = localStorage.getItem(summaryKey);
        
        if (summaryData) {
          const parsedData = JSON.parse(summaryData);
          console.log('ÊâæÂà∞Á´†ËäÇÊëòË¶Å:', chapterId);
          return parsedData.text;
        } else {
          console.log('Êú™ÊâæÂà∞Á´†ËäÇÊëòË¶Å:', chapterId);
          return null;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ´†ËäÇÊëòË¶ÅÂ§±Ë¥•:', error);
        return null;
      }
    },

    // ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç
    cancelCurrentSummaryRequest() {
      if (this.currentAbortController) {
        console.log('ÂèñÊ∂àÂΩìÂâçÊëòË¶ÅËØ∑Ê±Ç');
        this.currentAbortController.abort();
        this.currentAbortController = null;
        this.isGeneratingSummary = false;
        this.summaryText = '';
      }
    },

    // ÁîüÊàêÁ≤æÁ°ÆÁöÑÁ´†ËäÇID
    generateChapterId(location) {
      try {
        if (!location || !location.start) {
          return null;
        }

        // ‰ΩøÁî®Â§ö‰∏™Ê†áËØÜÁ¨¶ÁªÑÂêàÁîüÊàêÂîØ‰∏ÄÁöÑÁ´†ËäÇID
        const href = location.start.href || '';
        const cfi = location.start.cfi || '';
        const index = location.start.index || 0;
        
        // ÊèêÂèñÁ´†ËäÇÊñá‰ª∂ÂêçÔºàÂéªÊéâË∑ØÂæÑÂíåÊâ©Â±ïÂêçÔºâ
        let chapterName = '';
        if (href) {
          const urlParts = href.split('/');
          const fileName = urlParts[urlParts.length - 1];
          chapterName = fileName.split('.')[0]; // ÂéªÊéâÊâ©Â±ïÂêç
        }
        
        // ÁªÑÂêàÁîüÊàêÁ´†ËäÇID
        const chapterId = `${chapterName}_${index}`;
        
        console.log('ÁîüÊàêÁ´†ËäÇIDËØ¶ÊÉÖ:', {
          href,
          cfi: cfi.substring(0, 20),
          index,
          chapterName,
          finalId: chapterId
        });
        
        return chapterId;
      } catch (error) {
        console.error('ÁîüÊàêÁ´†ËäÇIDÂ§±Ë¥•:', error);
        // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®CFIÁöÑÂâç20‰∏™Â≠óÁ¨¶
        return location.start.cfi ? location.start.cfi.substring(0, 20) : 'unknown';
      }
    },

    async generateQuiz() {
      if (!this.plainTextContent || !this.ai) {
        alert('ËØ∑ÂÖàËÆæÁΩÆGemini API KeyÊàñÁ≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂÆåÊàê');
        return;
      }

      this.isGeneratingQuiz = true;
      this.showQuizModal = true;
      this.quizData = [];
      this.currentQuizIndex = 0;
      this.userAnswers = [];
      this.quizCompleted = false;
      this.quizScore = 0;

      try {
        const prompt = `In order for me to better understand the content of the chapter, please give me 3 quizes, each with 3 choices. with the format: Question: ...... ||Choices: A......,B....,C....||Correct:A/B/C.

Content: ${this.plainTextContent.substring(0, 2000)}`;

        const response = await this.ai.models.generateContent({
          model: "gemini-2.0-flash-exp",
          contents: prompt
        });

        const quizText = response.text;
        console.log('QuizÁîüÊàêÁªìÊûú:', quizText);

        // Ëß£ÊûêQuizÊï∞ÊçÆ
        this.quizData = this.parseQuizResponse(quizText);
        
        if (this.quizData.length === 0) {
          throw new Error('Êó†Ê≥ïËß£ÊûêQuizÊï∞ÊçÆ');
        }

        console.log('Ëß£ÊûêÂêéÁöÑQuizÊï∞ÊçÆ:', this.quizData);

      } catch (error) {
        console.error('ÁîüÊàêQuizÂ§±Ë¥•:', error);
        alert('ÁîüÊàêQuizÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        this.closeQuizModal();
      } finally {
        this.isGeneratingQuiz = false;
      }
    },

    parseQuizResponse(responseText) {
      const quizzes = [];
      
      // Â∞ùËØïÂ§öÁßçËß£ÊûêÊñπÂºè
      // const patterns = [
      //   // Ê®°Âºè1: Question: ... || Choices: A...,B...,C... || Correct: A/B/C
      //   /Question:\s*(.+?)\s*\|\|\s*Choices:\s*(A[^,]+),?\s*(B[^,]+),?\s*(C[^,]+)\s*\|\|\s*Correct:\s*(A|B|C)/gi,
        
      //   // Ê®°Âºè2: ÂàÜÂà´ÂåπÈÖç
      //   /Question:\s*(.+?)(?=\s*Choices:|$)/gi,
      //   /Choices:\s*(A[^,]+),?\s*(B[^,]+),?\s*(C[^,]+)/gi,
      //   /Correct:\s*(A|B|C)/gi
      // ];
      
      // È¶ñÂÖàÂ∞ùËØïÊ®°Âºè1ÔºàÂÆåÊï¥ÂåπÈÖçÔºâ
      let match;
      const fullPattern = /Question:\s*(.+?)\s*\|\|\s*Choices:\s*(A[^,]+),?\s*(B[^,]+),?\s*(C[^,]+)\s*\|\|\s*Correct:\s*(A|B|C)/gi;
      
      while ((match = fullPattern.exec(responseText)) !== null) {
        const question = match[1].trim();
        const choiceA = match[2].trim();
        const choiceB = match[3].trim();
        const choiceC = match[4].trim();
        const correct = match[5].trim();
        
        const correctMap = { 'A': 0, 'B': 1, 'C': 2 };
        
        quizzes.push({
          question: question,
          choices: [choiceA, choiceB, choiceC],
          correctAnswer: correctMap[correct]
        });
      }
      
      // Â¶ÇÊûúÊ®°Âºè1Ê≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÊ®°Âºè2ÔºàÂàÜÂà´ÂåπÈÖçÔºâ
      if (quizzes.length === 0) {
        const lines = responseText.split('\n');
        let currentQuiz = null;
        
        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          
          // ÂåπÈÖçÈóÆÈ¢ò
          if (line.startsWith('Question:')) {
            if (currentQuiz && currentQuiz.choices.length === 3 && currentQuiz.correctAnswer !== null) {
              quizzes.push(currentQuiz);
            }
            currentQuiz = {
              question: line.replace('Question:', '').trim(),
              choices: [],
              correctAnswer: null
            };
          }
          // ÂåπÈÖçÈÄâÈ°π
          else if (line.startsWith('Choices:')) {
            const choicesText = line.replace('Choices:', '').trim();
            // Êõ¥ÁÅµÊ¥ªÁöÑÈÄâÈ°πÂàÜÂâ≤
            const choices = choicesText.split(/[,Ôºå]/).map(c => c.trim()).filter(c => c);
            if (currentQuiz && choices.length >= 3) {
              currentQuiz.choices = choices.slice(0, 3);
            }
          }
          // ÂåπÈÖçÊ≠£Á°ÆÁ≠îÊ°à
          else if (line.startsWith('Correct:')) {
            const correctText = line.replace('Correct:', '').trim();
            if (currentQuiz) {
              const correctMap = { 'A': 0, 'B': 1, 'C': 2 };
              currentQuiz.correctAnswer = correctMap[correctText];
            }
          }
        }
        
        // Ê∑ªÂä†ÊúÄÂêé‰∏Ä‰∏™quiz
        if (currentQuiz && currentQuiz.choices.length === 3 && currentQuiz.correctAnswer !== null) {
          quizzes.push(currentQuiz);
        }
      }
      
      // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÊõ¥ÂÆΩÊùæÁöÑÂåπÈÖç
      if (quizzes.length === 0) {
        const questionMatches = responseText.match(/Question:\s*(.+?)(?=\s*Choices:|$)/gi);
        const choiceMatches = responseText.match(/Choices:\s*(.+?)(?=\s*Correct:|$)/gi);
        const correctMatches = responseText.match(/Correct:\s*(A|B|C)/gi);
        
        if (questionMatches && choiceMatches && correctMatches) {
          const minLength = Math.min(questionMatches.length, choiceMatches.length, correctMatches.length);
          
          for (let i = 0; i < minLength; i++) {
            const question = questionMatches[i].replace('Question:', '').trim();
            const choicesText = choiceMatches[i].replace('Choices:', '').trim();
            const choices = choicesText.split(/[,Ôºå]/).map(c => c.trim()).filter(c => c).slice(0, 3);
            const correct = correctMatches[i].replace('Correct:', '').trim();
            
            if (choices.length === 3) {
              const correctMap = { 'A': 0, 'B': 1, 'C': 2 };
              quizzes.push({
                question: question,
                choices: choices,
                correctAnswer: correctMap[correct]
              });
            }
          }
        }
      }
      
      console.log('Ëß£ÊûêÁªìÊûú:', quizzes);
      return quizzes;
    },

    selectAnswer(choiceIndex) {
      this.userAnswers[this.currentQuizIndex] = choiceIndex;
    },

    nextQuestion() {
      if (this.currentQuizIndex < this.quizData.length - 1) {
        this.currentQuizIndex++;
      }
    },

    previousQuestion() {
      if (this.currentQuizIndex > 0) {
        this.currentQuizIndex--;
      }
    },

    submitQuiz() {
      // ËÆ°ÁÆóÂæóÂàÜ
      let score = 0;
      for (let i = 0; i < this.quizData.length; i++) {
        if (this.userAnswers[i] === this.quizData[i].correctAnswer) {
          score++;
        }
      }
      
      this.quizScore = score;
      this.quizCompleted = true;
    },

    retakeQuiz() {
      this.currentQuizIndex = 0;
      this.userAnswers = [];
      this.quizCompleted = false;
      this.quizScore = 0;
    },

    closeQuizModal() {
      this.showQuizModal = false;
      this.isGeneratingQuiz = false;
      this.quizData = [];
      this.currentQuizIndex = 0;
      this.userAnswers = [];
      this.quizCompleted = false;
      this.quizScore = 0;
    },

    // ËÅäÂ§©Áõ∏ÂÖ≥ÊñπÊ≥ï
    openChatSidebar() {
      this.showChatSidebar = true;
      // Â¶ÇÊûúËæπÊ†èÂ∑≤ÊâìÂºÄÔºåÂÖ≥Èó≠ÂÆÉ
      if (this.showSidebar) {
        this.closeSidebarWithCancel();
      }
    },

    closeChatSidebar() {
      this.showChatSidebar = false;
    },

    async sendMessage() {
      if (!this.currentChatMessage.trim() || this.isSendingMessage) {
        return;
      }

      const userMessage = this.currentChatMessage.trim();
      
      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
      this.chatMessages.push({
        content: userMessage,
        isUser: true,
        timestamp: new Date()
      });

      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
      this.currentChatMessage = '';
      
      // ËÆæÁΩÆÂèëÈÄÅÁä∂ÊÄÅ
      this.isSendingMessage = true;

      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      this.$nextTick(() => {
        this.scrollToBottom();
      });

      try {
        // ÊûÑÂª∫‰∏ä‰∏ãÊñáÔºåÂåÖÂê´ÂΩìÂâçÁ´†ËäÇÂÜÖÂÆπ
        const context = this.plainTextContent ? `ÂΩìÂâçÁ´†ËäÇÂÜÖÂÆπÔºö${this.plainTextContent.substring(0, 1000)}` : '';
        const prompt = `${context}\n\nÁî®Êà∑ÈóÆÈ¢òÔºö${userMessage}\n\nËØ∑Áî®‰∏≠ÊñáÂõûÁ≠îÔºåÂõûÁ≠îË¶ÅÁÆÄÊ¥ÅÊòé‰∫Ü„ÄÇ`;

        const response = await this.ai.models.generateContent({
          model: "gemini-2.0-flash-exp",
          contents: prompt
        });

        // Ê∑ªÂä†AIÂõûÂ§ç
        this.chatMessages.push({
          content: response.text,
          isUser: false,
          timestamp: new Date()
        });

      } catch (error) {
        console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
        // Ê∑ªÂä†ÈîôËØØÊ∂àÊÅØ
        this.chatMessages.push({
          content: 'Êä±Ê≠âÔºåÊàëÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÈóÆÈ¢òÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ',
          isUser: false,
          timestamp: new Date()
        });
      } finally {
        this.isSendingMessage = false;
        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        this.$nextTick(() => {
          this.scrollToBottom();
        });
      }
    },

    scrollToBottom() {
      if (this.$refs.chatMessagesContainer) {
        this.$refs.chatMessagesContainer.scrollTop = this.$refs.chatMessagesContainer.scrollHeight;
      }
    },

    formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    },

    async generateGeminiSummary(content) {
      this.isGeneratingGeminiSummary = true;
      this.lastReadingSummary = '';
      try {
        if (!this.ai) {
          this.ai = new GoogleGenAI(this.geminiApiKey);
        }
        const prompt = `ËØ∑Áî®ÁÆÄÊ¥ÅÁöÑËØ≠Ë®ÄÊÄªÁªì‰ª•‰∏ãÈòÖËØªÂÜÖÂÆπÁöÑË¶ÅÁÇπÔºåÁ™ÅÂá∫Ê†∏ÂøÉ‰ø°ÊÅØÂíå‰∏ªË¶ÅËÑâÁªú(100Â≠óÂÜÖÔºâÔºö\n${content}`;
        const result = await this.ai.models.generateContent({
          model: "gemini-2.0-flash-exp",
          contents: prompt
        });
        this.lastReadingSummary = result.text;
      } catch (e) {
        this.lastReadingSummary = 'AIÊÄªÁªìÁîüÊàêÂ§±Ë¥•';
      } finally {
        this.isGeneratingGeminiSummary = false;
      }
    },

  },

  watch: {
    fileName: {
      handler(newVal, oldVal) {
        if (newVal !== oldVal) {
          this.loadBook();
        }
      },
      immediate: true,
    },
    showReadingProgressModal(val) {
      if (val && this.lastReadingInfo?.content) {
        this.generateGeminiSummary(this.lastReadingInfo.content)
      }
    },
  },

  mounted() {
    window.addEventListener('keydown', this.handleKeydown);
    window.addEventListener('resize', this.handleResize);
    window.addEventListener('beforeunload', this.saveCurrentLocation);
    window.addEventListener('click', (event) => this.hideContextMenu(event));
    window.addEventListener('mouseup', this.handleTextSelection);

    if (!this.fileName) {
      const savedFileName = localStorage.getItem('currentBook');
      if (savedFileName) {
        this.$router.replace({ name: 'BookReader', params: { fileName: savedFileName } });
      } else {
        this.$router.push({ name: 'Home' });
      }
    } else {
      localStorage.setItem('currentBook', this.fileName);
      this.loadBook();
    }

  },

  beforeUnmount() {
    // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
    window.removeEventListener('keydown', this.handleKeydown);
    window.removeEventListener('resize', this.handleResize);
    window.removeEventListener('beforeunload', this.saveCurrentLocation);
    window.removeEventListener('click', (event) => this.hideContextMenu(event));
    window.removeEventListener('mouseup', this.handleTextSelection);

    // Ê∏ÖÁêÜÂÆöÊó∂Âô®
    if (this.resizeTimeout) {
      clearTimeout(this.resizeTimeout);
    }

    // Ê∏ÖÁêÜ epub.js ËµÑÊ∫ê
    if (this.rendition) {
      try {
        this.rendition.destroy();
      } catch (error) {
        console.log('Ê∏ÖÁêÜ rendition Êó∂Âá∫Èîô:', error);
      }
    }

    if (this.book) {
      try {
        this.book.destroy();
      } catch (error) {
        console.log('Ê∏ÖÁêÜ book Êó∂Âá∫Èîô:', error);
      }
    }

    // Ê∏ÖÁêÜÈ´ò‰∫ÆÁõ∏ÂÖ≥ÁöÑÂÆöÊó∂Âô®
    if (this.isRestoringHighlights) {
      this.isRestoringHighlights = false;
    }

    // ÈöêËóèÊâÄÊúâËèúÂçï
    this.showContextMenu = false;
    this.showNoteInput = false;
    this.isHoveringHighlight = false;
    this.hoveredHighlightId = null;

    // Ê∏ÖÁêÜ DOM ÂÖÉÁ¥†
    const viewer = document.getElementById('viewer');
    if (viewer) {
      viewer.innerHTML = '';
    }
  },
};
</script>

<style scoped>
.book-content {
  transition: margin-right 0.3s cubic-bezier(0.4,0,0.2,1), max-width 0.3s cubic-bezier(0.4,0,0.2,1);
  margin-right: 0;
  max-width: 100vw;
  margin-left: auto;
  margin-right: auto;
}
.book-content.with-sidebar {
  margin-right: 384px; /* SidebarÂÆΩÂ∫¶w-96*/
  max-width: calc(100vw - 384px);
}
.book-content.with-chat-sidebar {
  margin-right: 384px; /* Chat SidebarÂÆΩÂ∫¶w-96*/
  max-width: calc(100vw - 384px);
}
@media (max-width: 900px) {
  .book-content.with-sidebar {
    margin-right: 0;
    max-width: 100vw;
  }
}
</style>